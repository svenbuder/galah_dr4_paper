\documentclass[
  journal=pasa,
  manuscript=research-paper, %% or "review"
  year=2023,
  volume=37
]{cup-journal}

\usepackage{microtype,siunitx,booktabs}

\DeclareRobustCommand{\VAN}[3]{#2}
\let\VANthebibliography\thebibliography
\def\thebibliography{\DeclareRobustCommand{\VAN}[3]{##3}\VANthebibliography}

%%%%% AUTHORS - PLACE YOUR OWN PACKAGES HERE %%%%%
\usepackage{graphicx}	% Including figure files
\usepackage{amsmath}	% Advanced maths commands
\usepackage{amssymb}	% Extra maths symbols
\usepackage{xspace}
\usepackage{upgreek}
\usepackage{hyperref}
\usepackage{pdflscape}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%% AUTHORS - PLACE YOUR OWN COMMANDS HERE %%%%%

% COMMANDS
\newcommand\ion[2]{\text{#1\,\textsc{\lowercase{#2}}}}	% ionization states

% COMMENTS
\newcommand{\SB}[1]{{\textcolor{purple}{#1}}}

% STELLAR LABELS
\newcommand{\Teff}{$T_\mathrm{eff}$\xspace}
\newcommand{\logg}{$\log g$\xspace}
\newcommand{\feh}{$\mathrm{[Fe/H]}$\xspace}
\newcommand{\numax}{$\nu_\mathrm{max}$\xspace}
\newcommand{\vmic}{$v_\mathrm{mic}$\xspace}
\newcommand{\vsini}{$v \sin i$\xspace}
\newcommand{\vrad}{$v_\mathrm{rad}$\xspace}

% NAMES
\newcommand{\TheCannon}{\textit{The Cannon}\xspace}
\newcommand{\sme}{\textsc{sme}\xspace}
\newcommand{\marcs}{\textsc{marcs}\xspace}
\newcommand{\Gaia}{\textit{Gaia}\xspace}
\newcommand{\TLF}{\Teff, \logg, and \feh}

% UNITS
\newcommand{\dex}{\,\mathrm{dex}}	% dex
\newcommand{\K}{\,\mathrm{K}}	% dex
\newcommand{\Msol}{\,\mathrm{M_\odot}} % Msol
\newcommand{\kpc}{\,\mathrm{kpc}}	% kpc
\newcommand{\mags}{\,\mathrm{mag}}	% mag
\newcommand{\yr}{\,\mathrm{yr}}	% Gyr
\newcommand{\Gyr}{\,\mathrm{Gyr}}	% Gyr
\newcommand{\eV}{\,\mathrm{eV}}	% eV
\newcommand{\Angstroem}{\,\text{\AA}}	% Angstroem
\newcommand{\kms}{\,\mathrm{km\,s^{-1}}}	% km/s
\newcommand{\kpckms}{\,\mathrm{kpc\,km\,s^{-1}}}	% kpc km/s
\newcommand{\kmkmss}{\,\mathrm{km^2\,s^{-2}}}	% km^2/s^2
\newcommand{\kmsMpc}{\,\mathrm{km\,s^{-1}\,Mpc^{-1}}}	% km/s/Mpc
\newcommand{\muHz}{\,\mathrm{\upmu Hz}} % micro Hz

\sisetup{detect-all,separate-uncertainty=true}

\title{The GALAH Survey: Data Release 4}

\author{S. Buder}
\affiliation{Research School of Astronomy \& Astrophysics, Australian National University, Canberra, ACT 2611, Australia}
\affiliation{ARC Centre of Excellence for All Sky Astrophysics in 3 Dimensions (ASTRO 3D), Australia}
\email[S. Buder]{sven.buder@anu.edu.au}

\author{Main contributors}
\author{survey builders}
\author{other co-authors with significant contribution}
\author{The GALAH Collaboration}
% \alsoaffiliation{Joint first authors}

%\handlingeditor{Excellent E Editor}

\doi{10.1017/pasa.2020.32}

\received {dd Mmm 2023}
\revised  {dd Mmm 2023}
\accepted {dd Mmm 2023}
\published{dd Mmm 2023}

\keywords{
Surveys; the Galaxy; methods: observational; methods: data analysis; stars: fundamental parameters; stars: abundances} %% First letter not capped
% \jel{Q11; Q12; D81; M31}
% \msc{Q14; Q18; E21}
% \abbreviations{
%     BDHS: Bangladesh Demographic and Health Survey, 
%     IDA: Fe-deficiency anaemia, 
%     IFA: Fe-folic acid, 
%     MNP: multiple micronutrient powder, 
%     VAD: vitamin A deficiency
% }

\begin{document}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{abstract}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The stars in our Milky Way hold the chemical history of our Milky Way in their atmospheres as they wander through our Galaxy. Like bar codes, we can extract the chemical fingerprint of stars from high-resolution spectra. The fourth data release (DR4) of the Galactic Archaeology with HERMES (GALAH) Survey provides the chemical abundances of up to 31 elements for 827\,288 stars which have exquisite orbit information from the \Gaia satellite information.

For this data release, we utilise neural networks to simultaneously fit all stellar labels (stellar parameters and elemental abundances) for the full wavelength range. The neural networks are trained on grids of synthetic spectra that were computed with Spectroscopy Made Easy.

In a first iteration, we fit the best set of labels and in particular radial velocities for all 943\,654 spectra (including repeat observations). These are used to properly co-add spectra (for example of spectroscopic binaries without line-splitting) for the second major iteration. This loop uses the distances inferred from astrometric data of the \Gaia satellite and 2MASS photometry to self-consistently infer more accurate and precise surface gravities for each star.

Notable improvements of this data release are the newly available abundances of carbon and nitrogen from molecular features as well as the significantly improved precision and amount of elemental abundances, in particular for neutron-capture elements.

The combination of chemical compositions across multiple nucleosynthesis pats, orbit information, and age estimates for almost a million stars from GALAH DR4 provides a rich data set for Galactic exploration.

\end{abstract}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{INTRODUCTION AND WORKFLOW}
\label{sec:introduction}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Motivation} \label{sec:motivation}

The history of our Milky Way galaxy is written in star light. By capturing and analysing the light of millions of stars that are now billions of years old, we can learn about the chemical composition of the material that was locked into their stellar atmospheres at birth. We can use stars as time capsules into the past evolution of the Milky Way. The light of stars can thus guide us to explore and map our environment, just as it guides Aboriginal and Torres Strait Islander people and their astronomers on Country since tens of thousands of years.

With this fourth data release (DR4) from the Galactic Archaeology with HERMES (GALAH), we are proudly publishing the next set of measurements of stellar chemical abundances for almost a third of the elements of the elements of the periodic table that are created by stars. The initial motivation for measuring so many elemental abundances was laid out by \citet{DeSilva2015} and included the major motivation - chemical tagging - with the aim to trace back stars that were born together through their (expected) similar chemical compositions. The recent and ongoing efforts of GALAH and other surveys like the SDSS/APOGEE surveys \citep[e.g.][]{SDSSDR17, Kollmeier2017}, LAMOST \citep{Zhao2012}, \Gaia-ESO \citep{Gilmore2022}, or RAVE \citep{Steinmetz2020a} have taught us that the chemical evolution of our galaxy and stars is complex and we cannot (yet) recover stellar siblings due to limitations in our observations, analyses methods, and intrinsic changes to chemical composition due stellar evolution. New observations and innovations in the analysis that are presented in this data release, will allow us to make significant progress towards chemical tagging.

The unique observational setup of GALAH allows us to deliver the chemical information for a powerful and substantial set of stars: those which have exquisite orbit information from the revolutionary \Gaia satellite \citep{Gaia-Collaboration2016} and for which we can estimate stellar ages either from empirical or theoretical models, like stellar isochrones or mass- and age-dependent changes of chemical compositions. By combining stellar ages, orbits, and chemistry, we have made major advances in our understanding of our Galaxy. In particular, the discovery of the major merger of the Milky Way with another slightly less massive galaxy between 8 and $10\,\mathrm{Gyr}$ ago \citep{Belokurov2018, Helmi2018} was paradigm shifting and motivated a new rush to collect more and diverse information about the stars in our Milky Way.

The work of this data release is motivated by expanding the previous analysis of spectra towards a more holistic workflow that can aid upcoming surveys like 4MOST \citep{4MOST2019} and WEAVE \citep{Dalton2014}. Switching to the use of neural networks for interpolating synthetic spectra allows us to model the full wavelength range, molecular features such from $\mathrm{C_2}$ and CN molecules, rather then a small selection of wavelength windows around atomic lines. It even enables us to model all stellar labels (global parameters and elemental abundances) simultaneously and derive interstellar properties from the residuals of observations and synthetic stellar spectra. Finally, we can also relax the (often wrong) assumption that we observe single stars, by superimposing synthetic spectra of two stars, and thus provide global parameters for binary systems as part of our workflow.

\subsection{Workflow} \label{sec:workflow}

The workflow of GALAH DR4 is depicted in Fig.~\ref{fig:workflow_galah_dr4}. Following this workflow throughout this manuscript, we first describe the collection of data in Sec.~\ref{sec:data}, most notably the observation of HERMES spectra. We explain how we create synthetic stellar spectra to compare with the observed ones in Sec.~\ref{sec:synthetic_spectra}. The comparison is then done in two consecutive steps. In Sec.~\ref{sec:allspec_analysis}, we explain how we extract stellar labels from individual observations (without non-spectroscopic information folded in), while Sec.~\ref{sec:allstar_analysis} describes how we co-add repeated observations and fold in non-spectroscopic information for each star. Sec.~\ref{sec:binary_analysis} describes how we estimate main stellar labels for binary stars. We describe the post-processing of our data in Sec.~\ref{sec:post_processing} and validate our measurements in Sec.~\ref{sec:validation}. We describe the data products of this data release in Sec.~\ref{sec:catalogues_release_products} and conclude this manuscript in Sec.~\ref{sec:conclusion}.

\begin{figure}[ht]
 \centering
 \includegraphics[width=\textwidth]{figures/workflow_galah_dr4.png}
 \caption{\textbf{Workflow of GALAH DR4}}
 \label{fig:workflow_galah_dr4}
\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{DATA}
\label{sec:data}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The GALAH Survey is using the 3.9-metre Anglo-Australian Telescope at Siding Spring Observatory on Gamilaraay Country and its Two-Degree Field positioning system (2dF) topend \citep{Lewis2002}. 2dF places up to 400 fibre entrances on one of two plates which can be tumbled to allow parallel observing and fibre configuring. Light is then send through fibres to the High Efficiency and Resolution Multi-Element Spectrograph (HERMES) spectrograph \citep{Barden2010, Brzeski2011, Heijmans2012, Farrell2014, Sheinis2015} and dispersed into four non-contiguous wavelength bands in the optical and captured in separate rows of four separate charge-coupled devices (CCDs). The data used in this data release is primarily based on observations of stars with said setup, but also makes us of auxiliary photometric and astrometric information for the stars, where available.

In this Section, we describe which stars we have targeted and observed (Sec.~\ref{sec:target_selection_observations}) with the 2dF-HERMES setup, including the first description of the second phase of GALAH observations (GALAH Phase 2) with a sharper focus on main-sequence turnoff stars to estimate more precise ages. In Sec.~\ref{sec:spectroscopic_data_from_galah_observations}, we briefly summarise the properties of the spectroscopic data and how they were reduced to one-dimensional spectra. We also point out major changes of the observations and reductions with respect to the previous third data release \citep{Buder2021}. We further elaborate on the auxiliary information that was used for the analysis in Sec.~\ref{sec:non-spec_data}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Target selection and observational setup} \label{sec:target_selection_observations}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

GALAH DR4 is a combination of the main GALAH survey and additional proposals to observe targets of the K2 \cite{Sharma2019} and TESS missions \cite{Sharma2018} to combine spectroscopic and asteroseismic data, as well as hand-picked and random observations of globular and open cluster members. The column \texttt{survey\_name} in our catalogues denotes this origin.

\subsubsection{Target selection of GALAH Phase 1 and 2}

For GALAH Phase 1, we used the 2MASS photometric survey \citep{Skrutskie2006} with its $J$ and $Ks$ filters as parent sample, from which we selected stars within empirical visual magnitudes
\begin{equation}
V_\mathrm{JK} = K_S+2(J-K_S+0.14)+0.382e^{((J-K_S-0.2)/0.5)}.
\end{equation}

For GALAH Phase 1, a tiling pattern (with unique \texttt{field\_id} entries) with $2\,\mathrm{deg}$ fields of view below declination $\delta < 10\,\mathrm{deg}$ were created for regions with Galactic latitude $\vert b \vert > 10\,\mathrm{deg}$ to avoid crowding and strong extinction. For each tile, a selection of 400 stars within magnitudes $9 < V_\mathrm{JK} < 12$ for a bright magnitude cut and $12 < V_\mathrm{JK} < 14$ for the nominal magnitude cut is randomly selected from the complete parent sample of 2MASS. This typically selects 2/3 main sequence and turnoff stars and 1/3 evolved stars.

For GALAH Phase 2, a stronger focus on turn-off stars was implemented with the photometric and astrometric information of \Gaia data release 2 as parent sample. For each field, we therefore first allocate fibres to stars with absolute magnitude between $2 < M_G < 4$, where
\begin{equation}
M_G = \texttt{phot\_g\_mean\_mag} + 5 \cdot \log_{10} \left( \frac{\texttt{parallax}}{100\,\mathrm{mas}} \right)
\end{equation}
with $G$ magnitude and parallax measurements from \Gaia DR2 \citep{Brown2018, Evans2018, Lindegren2018}. Remaining fibres are again filled with targets as done in Phase 1.

\subsubsection{Observational setup}

\begin{table}
\centering
 \caption{\textbf{Overview of stars observed for the programs included in this data release.} Numbers of open and globular cluster observations were estimated after observations as described in Sec.~\ref{sec:oc_gc}. We have observed 18 globular clusters (13 with $\geq$ 5 stars) and 286 open clusters (94 with $\geq$ 5 stars).}
\label{tab:field_ids}
\begin{tabular}{crcr}
\hline \hline
Program & Nr. Stars & Program & Nr. Stars \\
\hline
galah\_bright & 65\,188 & 
k2\_hermes & 117\,708\\
galah\_main & 427\,699 & 
tess\_hermes & 37\,228\\
galah\_faint & 25\,802 & 
globular clusters & 1\,185\\
galah\_phase2 & 125\,058 & 
open clusters & 4\,487\\
commissioning & 2\,625 & 
other & 20\,308\\
  \hline
 \end{tabular}
\end{table}

\begin{figure*}[ht]
 \centering
 \includegraphics[width=\textwidth]{figures/210115002201239_abundance_examples.png}
 \caption{\textbf{Comparison of normalised observed (black) and synthetic spectra (blue) of the asteroid 4 Vesta with solar composition as well as examples of synthetic spectra with non-solar abundances.}
 \textbf{Panels a-d)} show the observed and best-fit synthetic spectrum as well as their absolute residual (pink) for the four wavelength channels of the HERMES spectrograph.
 \textbf{Panel e)} shows the beginning of the blue CCD 1 (left-most part of panel a) with an additional synthetic spectrum of ten-times higher C in orange, for which the $\mathrm{C}_2$ molecular absorption, the Swan bands, features would be prominent.
 \textbf{Panel f)} shows the beginning of the green CCD 2 (left-most part of panel b) and exemplifies with a synthetic spectrum in green that also a ten-times lower Na abundance (for example of accreted stars) can still be detected. 
 \textbf{Panel g)} shows the end of the red CCD 3 with a synthetic spectrum of primordial Li abundance of $\mathrm{A(Li)} = 2.75$ in red. While this abundance could be detected, the the line for the Solar value $\mathrm{A(Li)} = 1.05$ is barely detectable.
 \textbf{Panel h)} shows the end of the infrared CCD 4, which would show strong molecular absorption features of the CN molecule for $\mathrm{[N/Fe]} = 1$ (purple).
 }
 \label{fig:210115002201239_abundance_examples}
\end{figure*}

We list the observations under certain programs in Table~\ref{tab:field_ids}. Except for 2\,935 spectroscopic observations with the high-resolution mode of HERMES ($R \sim 42\,000$) on 7/8/10/11/$12^\text{th}$ February 2014, all observations were made in the low-resolution mode ($R \sim 28\,000$). Exposure times depend on programs. Under sufficient conditions (no clouds and seeing below $2\,\mathrm{arcsec}$), GALAH Phase 1 and TESS-HERMES observed 3x6 minutes for bright targets ($9 < V_\mathrm{JK} < 12$) and 3x20 minutes for the majority of targets ($12 < V_\mathrm{JK} < 14$). GALAH Phase 2 extended these times to 3x10 and 3x30 minutes, respectively, and included repeat observations of GALAH Phase 1 main targets with another 3x15 minutes. K2-HERMES observations targeted stars with $13 < V_\mathrm{JK} < 15$ or even $13 < V_\mathrm{JK} < 15.8$ to complement targets of the K2 Galactic Archaeology Program \citep{Stello2015} and were observed for 2 hours, similar to most globular and open cluster stars. Worse seeing conditions or thin clouds caused triggered between one ($2 < \mathrm{seeing} < 2.5\,\mathrm{arcsec}$) and 3 ($2.5 < \mathrm{seeing} < 3\,\mathrm{arcsec}$) additional exposures. In addition to the science frames, fibre flat and arc observations from a ThXe were taken before or after each exposure together with bias frames at the beginning of each night.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Spectroscopic data from GALAH observations}
\label{sec:spectroscopic_data_from_galah_observations}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Since the commissioning of the HERMES spectrograph in late 2013 until 22 August 2022, the GALAH collaboration and its partners have observed and successfully reduced 943\,654 spectra of 827\,288 stars. The spectroscopic data is collected by four separate CCDs that cover $\sim 1000\,\text{\AA}$ in the range of $4713-4903$ (blue CCD or CCD1), $5648-5873$ (green / CCD2), $6478-6737$ (red / CCD3), and $7585-7887\,\text{\AA}$ (infrared IR / CCD4), as can be seen from the reduced example spectrum of the asteroid 4 Vesta in Fig.~\ref{fig:210115002201239_abundance_examples}. The reduction process to create FITS files of reduced spectra from two-dimensional images of the cameras is employing an updated and publicly available \href{https://github.com/sheliak/galah_reduction/blob/master/extract6.0.py}{version 6} of the already well-tested reduction pipeline \citep{Kos2017}. The extensions of these files are listed in Tab.~\ref{tab:reduction_fits} and created as follows.

\begin{table}
    \centering
    \caption{Data product 1: FITS files of reduced spectra}
    \label{tab:reduction_fits}
    \begin{tabular}{cc}
    \hline \hline
    FITS Ext. & Description \\
    \hline
    Ext. 0 & Un-normalised signal~/~counts \\
    Ext. 1 & Normalised signal (by reduction pipeline) \\
    Ext. 2 & Relative uncertainty of signal \\
    Ext. 3 & Subtracted sky signal~/~counts \\
    Ext. 4 & Applied telluric correction \\
    Ext. 5 & Scattered light~/~counts \\
    Ext. 6 & Cross-talk \\
    Ext. 7 & Resolution profile~/~FWHM \\
    \hline
    \end{tabular}
\end{table}

Science frames are corrected by removing biases, fixing gains of the two CCD halfs, fixing bad pixels, dividing by master flats, as well as removing cosmics and scattered light. Subsequently, apertures are identified and use to extract the individual spectra. 

Wavelength calibrations are performed via Chebychev polynomial functions based on the ThXe arc frames and the spectra are interpolated onto a linearly increasing wavelength grid with starting wavelength \texttt{CRVAL1} and dispersion \texttt{CDELT1}. Both values are saved in the headers of the FITS files.

Finally, sky lines are subtracted and telluric lines removed, before a barycentric correction is applied to create the 'reduced' spectra that are saved in extension~1 of the reduction pipeline FITS files and used for the subsequent analysis. 

Noise / uncertainties are saved in extension~2 and calculated from the square root of the sum of flux, sky features (extension~3)\footnote{\SB{telluric features (extension~4) are not added in line 3424 of extract6.0.py.}}, scattered light (extension~5), crosstalk (extension~6) and as well as the squared readout noise.

The wavelength dependent line spread functions (LSFs) are measured from the arc calibration frames for each spectrum and CCD by fitting modified Gaussian distributions with a boxiness parameter $b$ and full width half maxima $fwhm$ for each wavelength point of the spectrum, that is
\begin{align}
    \exp \left(-0.693147 \vert 2 \cdot \textbf{\textit{x}}/\texttt{fwhm}\vert^\texttt{b}\right) \label{eq:lsf}
\end{align}
The array $\textbf{\textit{x}}$ then includes the pixels around each wavelength step that are used to apply the convolution from higher resolution to GALAH resolution spectra. The fitted values of $fwhm$ are saved in extension~7 with $b$ in its header.

\SB{Should we elaborate on any overall information, like SNR overview and pointing on the sky?}
\SB{Elaborate on how the reduction pipeline parameters \texttt{teff\_r} etc. are estimated.}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Auxiliary data from \Gaia, 2MASS, and literature} \label{sec:non-spec_data}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%SELECT
%galah.sobject_id,
%tmass.designation as tmass_id,
%tmass.ph_qual as tmass_ph_qual,
%tmass.ra as raj2000,
%tmass.dec as dej2000,
%tmass.j_m, tmass.j_msigcom,
%tmass.h_m, tmass.h_msigcom,
%tmass.ks_m, tmass.ks_msigcom,
%calj.r_med_geo,calj.r_lo_geo,calj.r_hi_geo,
%calj.r_med_photogeo,calj.r_lo_photogeo,calj.r_hi_photogeo,
%calj.flag as calj_flag,
%gaia.*
%FROM gaiadr3.gaia_source as gaia
%LEFT OUTER JOIN
%	external.gaiaedr3_distance as calj
%	ON calj.source_id = gaia.source_id
%LEFT OUTER JOIN
%	gaiadr3.tmass_psc_xsc_best_neighbour AS tmassxmatch
%	ON tmassxmatch.source_id = gaia.source_id
%LEFT OUTER JOIN
%	gaiadr3.tmass_psc_xsc_join AS tmass_join
%	ON tmass_join.clean_tmass_psc_xsc_oid = tmassxmatch.clean_tmass_psc_xsc_oid
%LEFT OUTER JOIN
%	gaiadr1.tmass_original_valid as tmass
%	ON tmass.designation = tmass_join.original_psc_source_id
%INNER JOIN
%	user_sbuder.dr6_0_230101_unique_ids as galah
%	ON galah.tmass_id = tmass.designation

To support our spectroscopic analysis, we make use of astrometric and photometric information from the \Gaia satellite \citep{Gaia-Collaboration2016} and 2MASS survey \citep{Skrutskie2006} which is available for essentially all our targets. $Gaia$: 826\,076 (99.9\,\%) of the 827\,288 stars observed by GALAH have photometric measurements catalogued in \Gaia DR3 and the 2MASS Survey. We further use the value-added catalogues, like distance estimates for field stars by \citep{BailerJones2021} as well as open and globular clusters by \citet{CantatGaudin2020} as well as \citet{Vasiliev2021} and \citet{Baumgardt2021}.

\subsubsection{\Gaia DR3}

We crossmatch our observations to the \Gaia DR3 catalogue \citep{Brown2021,Vallenari2022} via the 2MASS via the nearest neighbour crossmatches provided as part of \Gaia DR3 \citep{Torra2021}. 820\,715 (99.2\,\%) also have astrometric information \citep{Lindegren2021a} and 774\,915 stars (93.7\,\%) have radial velocity estimates \citep{Katz2022}. We apply the corrections to both photometric \citep{Riello2021} and astrometric \citep{Lindegren2021b}information. Where possible we prefer the photogeometric distances over the geometric distances by \citep{BailerJones2021}. Where neither are available, we further try to find parallaxes from \cite{vanLeeuwen2007}. The average parallax uncertainty of the GALAH stars is $\sigma_{\varpi} / \varpi = 1.5_{-0.9}^{+2.6}\,\mathrm{\%}$. Only $2.3\,\%$ of GALAH stars have no parallax measurements or parallax measurements beyond $20\%$ uncertainty, for which the priors by \citep{BailerJones2021} start to dominate distance estimates.

\subsubsection{2MASS, WISE, and extinction}

In addition to the excellent infrared photometry for 99.9\,\% of our sources from the 2MASS survey \citep{Skrutskie2006}, 98.7\,\% of them have far-infrared measurements from the WISE mission \citep{Cutri2013}. We therefore can estimate the extinction in the $K_S$, via the RJCE method \citep{Majewski2011} $A_{K_S}  = 0.917 \cdot \left( H - W2 - 0.08 \right)$ for most stars. We confirm this estimate by estimating the extinction in $K_S$ via the extrapolation of the color extinction of $B-V$, that is, $A(K_S) \sim 0.36 \cdot E(B-V)$ \citep{Cardelli1989}. We revert to this value, if it is less than half the value of the RJCE estimate or if either of the H and W2 bands does not have an excellent quality flag 'A'. For negative estimates by the RJCE method and very nearby stars ($<100\,\mathrm{pc}$) we null the value.

\subsubsection{Open and Globular Cluster members and distances} \label{sec:oc_gc}

We identify open cluster members via the membership catalogue from \citet{CantatGaudin2020} via crossmatch with the \Gaia \texttt{source\_id} and adjust their parallaxes and distance estimates to the average cluster values if the latter are more precise. We identify globular cluster members (with more than 70\% probability) via the membership catalogue from \citet{Vasiliev2021} by crossmatching with the \Gaia \texttt{source\_id}. We then adjust the parallaxes and distances for the member stars to the mean values listed by \citet{Baumgardt2021}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{SYNTHETIC SPECTRA FOR 2DF-HERMES}
\label{sec:synthetic_spectra}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The aim of our spectroscopic analysis is to estimate the best set of stellar properties (labels) that influence a stellar spectrum by minimising the difference of observed stellar spectra to synthetic ones that were created with said stellar labels. In our endeavour to push the limits even further, we are advancing our analysis to fit all 31 elemental abundances and stellar parameters across the full GALAH wavelength range simultaneously with the appropriate model spectra. In this release we implement the possibility to also create synthetic binary star spectra through the superposition of two synthetic spectra and optimise them and respective radial velocity shifts of the binary stars.

To make this computationally feasible, we follow an idea reported by \citet{Rix2016} and create flexible models for smaller parts of the parameters space from only a limited number of ab initio models \citep[see also][]{Ting2016b}. Our ab initio models are calculated with Spectroscopy Made Easy \citep[\textsc{sme}][]{Valenti1996,Piskunov2017} for the whole wavelength range and all visible atomic and molecular lines for random selections of elemental abundances and stellar parameters within the range of \textsc{marcs} atmospheres \citep{Gustafsson2008} at much higher resolution and sampling than our HERMES spectra. We then select subsets of these spectra within a restricted space of the three main spectroscopic parameters \Teff, \logg, and [Fe/H]. This idea is comparable to selecting Solar or stellar twin spectra when analysing the Sun \citep[see e.g.]{Nissen2015} or differential abundance analysis of globular cluster stars \citep[e.g.]{Yong2013, Monty2023}. As they cancel out several systematic issues of line data and atmospheric effect, these approaches have been highly successful \citep{Nissen2018}. For each subset, we train a neutral network that correlates stellar flux and labels (stellar parameters and abundances) similar to \textit{The Payne} \citep{Ting2019}. With these models, we can then create model spectra with all lines over the whole wavelength range for any combination of element abundances within this restricted parameter space within less than a second (compared to minutes or hours for physics-driven syntheses). 

Another reason to create smaller training sets rather than a "one-fit-all" approach was the limited flexibility of both quadratic and non-linear interpolation routines within computationally reasonable model sizes and ability to test the model accuracy over the full parameter space. Surveys like GALAH, RAVE or APOGEE aim to fit basically all types of spectra at once. This means we demand one model to predict Sun-like stars, red clump stars, metal-poor stars with almost no absorption features, cool evolved stars with strong molecular features, and hot stars with shallow and broad lines - all at once and for up to 31 elemental abundances. As one can imagine this is an impossible task and has led to numerous systematic trends in catalogues for the most extreme cases  that use such model interpolations \citet{Buder2018,Casey2016,Ting2019}. In this data release, we therefore purposefully limit the spectral complexity by creating smaller models. The hot star model therefore does not need to also predict the strong molecular absorption features of a cool stars. We discuss the possible caveats and disadvantages of this approach and our particular implementation in Sec.~\ref{sec:caveats}.

In this section, we lay out how we create smaller bins in the parameter space from which we sample a training set (Sec.~\ref{sec:higher_resolution_synthetic_spectra}) rather than one training set for all stars. We lay out how we create the parent sample of high-resolution synthetic stellar spectra (Sec.~\ref{sec:higher_resolution_synthetic_spectra}) and train neural networks to quickly predict/interpolate new synthetic spectra (Sec.~\ref{sec:interpolating_synthetic_spectra_with_neural_networks}).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Stellar twin training sets rather than one-fits-all}
\label{sec:spectrum_grid}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{figure}[ht]
 \centering
 \includegraphics[width=\textwidth]{figures/teff_logg_grid_coverage.png}
 \caption{\textbf{Coverage in \Teff and \logg of MARCS2014 grid (red) and GALAH DR3 (black, including density countour).} Shown is also an example of one of the 3D bins used to create models with \TheCannon. MARCS grid points \Teff$ < 3100\K$ or \feh$<-3\dex$ are neglected throughout GALAH DR4.}
 \label{fig:teff_logg_grid_coverage}
\end{figure}

The base grid for our training set computation is the \marcs grid \citep{Gustafsson2008}, which is shown with red points in Fig.~\ref{fig:teff_logg_grid_coverage}. Following the aforementioned idea of restricting ourselves to stellar siblings, we create multiple 3-dimensional bins in \Teff, \logg, and \feh within $\pm 1$ grid points in \Teff (with either $\pm 250$ or $\pm 100\K$), \logg ($\pm 0.5\dex$), and \feh ($\pm 0.5$ or $\pm 0.25\dex $). An example box is shown for Solar siblings bin as blue box in Fig.~\ref{fig:teff_logg_grid_coverage}.

Within these bins, we sample 280\footnote{This number is chosen to match the 28 CPUs of our computing nodes.} synthetic spectra with no rotational broadening, which are later broadened with different rotational velocities $v \sin i$ to create between 1680 and 2240 training set spectra for each bin. We explain the sampling of parameters and abundances in an exemplary way for the 3D bin centred on $T_\text{eff} = 5750\pm250\K$, $\log g = 4.5\pm0.5\dex$ and $\mathrm{[Fe/H]} = 0.0\pm0.25\dex$ (see blue box in Fig.~\ref{fig:teff_logg_grid_coverage}).

\begin{figure*}[ht]
 \centering
 \includegraphics[width=\textwidth]{figures/example_3d_bin_sample.png}
 \caption{\textbf{Coverage of stellar parameters and abundances for one of the 3D bins.} Shown is the example of the solar 3D bin ($T_\mathrm{eff}~/~\mathrm{K} = 5750$, $\log (g~/~\mathrm{cm\,s^{-2}}) = 4.5$, $\mathrm{[Fe/H]}~/~\mathrm{dex} = 0.0$). \textbf{Panel a):} \Teff and \logg, \textbf{Panel b):} [Fe/H] vs. [Li/Fe], \textbf{Panel c):} [Fe/H] vs. [O/Fe], \textbf{Panel d):} [Fe/H] vs. [Mg/Fe]. While \Teff, \logg, and \feh are sampled randomly within the 3D bin, the abundances are sampled both narrowly (blue) and broadly (purple) within limits as described in the text. Red point indicate the median spectrum and orange points the adjusted spectra to test the gradient change of spectra with individual label.}
 \label{fig:example_3d_bin_sample}
\end{figure*}


\begin{table*}[ht]
\centering
 \caption{Example of boundaries for the uniform sampling of synthetic spectrum labels (stellar parameters and elemental abundances) for the 3-dimensional bin of Solar siblings \texttt{5750\_4.50\_0.00}.}
\label{tab:sampling_xfe}
\begin{tabular}{lclclc}
\hline \hline
Parameter & Sampling & Element & Sampling Narrow & Element & Sampling Broad \\
\hline
$T_\text{eff}~/~\K$ & 5500..5750..6000 & $\mathrm{A(Li)}$ & {1.05..2.75..3.26} & $\mathrm{A(Li)}$ & {0.00..4.00} \\
$\log g~/~\dex$ & 4.0..4.5..5.0 &  $\mathrm{C,~N,~O}$ & {-0.5..0.0..1.0} & $\mathrm{C,~N,~O}$ & {-1.0..1.5} \\
$\mathrm{[Fe/H]}~/~\dex$ & {-0.25..0.0..0.25} & $\mathrm{Y,~Ba,~La,~Ce,~Nd}$ & {-0.5..0.0..1.0} & $\mathrm{Y,~Ba,~La,~Ce,~Nd}$ & {-1.0..1.5} \\
$v_\text{mic}~/~\kms$ & {0.5,1.5,4.0}, but see Eq.~\ref{eq:vmic_initial} & $\mathrm{[X/Fe]~for~Mg,~Si,~Ti}$  &  {-0.5..0.0..0.5}& $\mathrm{[X/Fe]~for~Mg,~Si,~Ti}$ & {-0.5..1.0} \\
$v \sin i~/~\kms$ & 0.0\text{, but see Eq.~\ref{eq:vsini}} & $\mathrm{[X/Fe]~for~all~other~elements}$ & {-0.5..0.0..0.5} & $\mathrm{[X/Fe]~for~all~other~elements}$ & {-1.0..1.0}  \\
\hline \hline
\end{tabular}
\end{table*}

Stellar parameters (\Teff, \logg, \feh, \vmic) and elemental abundances [X/Fe] of all 30 elements are randomly sampled within reasonable limits (see examples in Tab.~\ref{tab:sampling_xfe}) and fed into \sme to create self-consistent synthetic spectra over the full wavelength range for \marcs atmospheres. 

\vmic values are sampled uniformly between the upper and lower limits of the empirical relation from GALAH DR3 \citep[Eqs.~4 and 5 from][]{Buder2021} and an adjusted version of the relation by \citet{DutraFerreira2016}. The latter has been adjusted for $T_\text{eff}^\prime = T_\text{eff} - 5500\,\mathrm{K}$ as well as $\log g^\prime = \log g - 4.0$ to return:
\begin{align} 
v_\text{mic} = \begin{array}{l}
1.198 + 3.16 \cdot 10^{-4} \cdot T_\text{eff}^\prime - 0.253 \cdot \log g^\prime \\ - 2.86\cdot 10^{-4} \cdot T_\text{eff}^\prime \cdot \log g^\prime + 0.165 \cdot \log g^\prime
\end{array} \label{eq:vmic_initial}
\end{align}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Higher-resolution synthetic spectra with \sme}
\label{sec:higher_resolution_synthetic_spectra}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

We create training sets from high-resolution stellar spectra for each smaller 3D bin region of the parameter space. We compute over-sampled synthetic intensity spectra at ten times higher resolution then the typical GALAH resolution with \sme for seven equal-area angles of a stellar surface (see Fig.~\ref{fig:sme_mu_output}).

\begin{figure}[hbt]
 \centering
 \includegraphics[width=\textwidth]{figures/solar_twin_specific_intensity.png}
 \caption{\textbf{Example output of \sme for a solar spectrum in HERMES CCD3 (around the Balmer $\mathrm{H}_\alpha$ line).} Shown are the the specific intensities (\texttt{sme.sint}) as a function of the equal-area midpoints of each equal-area annulus $\mu$.}
 \label{fig:sme_mu_output}
\end{figure}

For each spectrum, we first run a test on all available lines in the GALAH linelist, which is adapted from \citet{Heiter2021} and includes small changes to correct wrong $\log gf$ values for few lines within the GALAH wavelength range. We keep all atomic lines for the final synthesis and restrict the molecular lines to those with \textsc{sme}.depth above 0.001.

Spectra are computed at a resolution of $R = 300,000$ on a fine wavelength grid with 60,819 pixels spread over the extended wavelengths $4675.1- 4949.9$, $5624.1-5900.9$, $6424.1-6775.9$, and $7549.1-7925.9 \Angstroem$. We note that these extend significantly beyond the actual GALAH wavelength range.

We use 1D \marcs atmospheres from the \marcs grid \citep[][version 2014]{Gustafsson2008}, and interpolate them for combinations of \Teff, \logg, and \feh. We use grids of non-LTE departure coefficients by \citet{Amarsi2020} for H, Li, C, N, O, Na, Mg, Al, Si, K, Ca, Mn, and Ba. For all, except C, we use grids that include background scattering.

Our synthetic grid explicitly includes C and N abundances. C was previously included in the analysis of GALAH DR3, but limited to the atomic C line. The analysis thus neglected the molecular absorption features of $\mathrm{C_2}$ and CN at the beginning of CCD1 and end of CCD4, respectively. With the new self-consistent grid, we can however include these features, as they hold valuable information for both C and N, as well as several other features through the molecular equilibrium in stars \citep[see e.g.][]{Ting2018}.

To be able to test that the flux-label correlations found by our subsequent polynomial interpolation are limited to reasonable wavelength ranges, we also calculate one spectrum that is exactly in the middle of the parameter range and additional spectra, where we increase the value of one label at a time (e.g. increase [O/Fe] by $1\dex$) to test the response in the synthetic spectrum.

To save computational costs, we compute synthetic spectra with no rotational or macroturbulence broadening ($v_\text{mac} = v\sin i = 0\kms$), but save the model continuum flux (\texttt{sme.cmod}) and the specific intensities (\texttt{sme.sint}) as a function of the equal-area midpoints of each equal-area annulus $\mu$ (see Fig.~\ref{fig:sme_mu_output}). We then apply the broadening of spectra due to rotation (\vsini) with the flux integration code of the python-implementation \textsc{PySME} \citep{Wehrhahn2021} of \textsc{SME} \citep{Piskunov2017}. Depending on the expected rotational velocities (increasing with temperature) we sample a range of
\begin{align} \label{eq:vsini}
    v \sin i~/~\kms \in \{ 1.5, 3, 6, 9, 12, 18, 24^\star, 36^{\star \star}\}.
\end{align}

For bins with \Teff$\geq 5000\,\mathrm{K}$, we also include $v \sin i = 24 \kms$ and for those with \Teff$\geq 6000\,\mathrm{K}$ we also include $v \sin i = 36 \kms$. 
% The decision for these values was made based on the distribution of \vsini ($7.2_{-1.6}^{4.9}\kms$ with 90\% between 4.7 and $29.0\kms$) in GALAH+ DR3 \citep{Buder2021} and comparison with the grid values used by APOGEE DR16 \citep{Joensson2020}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Interpolating synthetic spectra with neural networks} \label{sec:interpolating_synthetic_spectra_with_neural_networks}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

To allow a fast interpolation with new and different stellar labels, we use the method of training descriptive models to connect stellar fluxes at given pixels from a combination of stellar labels. This method is well established in stellar spectroscopy through the successful applications of quadratic models with \textit{The Cannon} \citep[see e.g.][]{Ness2015, Ness2016, Casey2016, Casey2017, Ho2017, Buder2018} as well as neural networks with \textit{The Payne} \citep[see e.g.][]{Ting2019, Xiang2019, Xiang2021}. Because of the needed flexibility\footnote{For a more detailed discussion on the advantages of neural networks for predicting spectra see \citet{Ting2019}.} to predict synthetic spectra with 36 stellar labels for a large parameter space, we are also choosing neural networks to interpolate between our synthetic spectra in this data release.

In particular, we use the neural network architecture and training algorithms of \textit{The Payne} \citep{Ting2019} for our data. We describe the connection of stellar labels $\boldsymbol{\ell}$ and the flux $f$ at each wavelength pixel $\lambda$ via
\begin{equation}
f_\lambda = w \cdot \sigma\bigg( \tilde{w}_\lambda^i \sigma \Big( w^k_{\lambda i} \ell_k + b_{\lambda i} \Big) + \tilde{b} \bigg) + \bar{f}_\lambda,
\label{eq:neural_network_function}
\end{equation}
where $\sigma$ is the Sigmoid function $\sigma (x) = 1/(1 + e^{-x})$ that encapsulates the so called layers of a neural network with $i = 300$ neurons \citep[see ][for more details]{Ting2019}. After optimising a loss function for $10^4$ steps, we consider the network trained with an optimised combination of three sets of weights and biases within the minimum and maximum ranges of each label. The trained networks can then be used with new input labels to quickly create synthetic spectra for the label optimisation.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{SINGLE SPECTRUM ANALYSIS (ALLSPEC)}
\label{sec:allspec_analysis}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

As outlined in Sec.~\ref{sec:introduction}, the workflow of GALAH DR4 includes a first analysis step of all observed spectra without taking non-spectroscopic information for the optimisation. This allows to identify shifts of radial velocities between spectroscopic observations of the same stars\footnote{While repeat observations were only done for quality assurance in GALAH Phase 1, we have started to revisit a large amount of the fields for another 2x15 minuates to reach the updated needed exposure time for main GALAH fields of 1.5 hours.} and a more accurate co-adding of spectra for the \textit{allstar} analysis (see Sec.~\ref{sec:allstar_analysis}). Another motivation for this step is to get a first estimate of stellar labels without potentially biased photo- and astrometric, for example for binary stars.

The optimisation of stellar labels is thus aiming to minimise the absolute difference between synthetic and observed spectrum for all unmasked pixels, weighted by their uncertainty. Starting from a set of initial labels (Sec.~\ref{sec:initial_stellar_labels}), we create high-resolution synthetic spectra and downgrade them to the observed resolution and wavelength grid of each spectrum. In an important improvement of our analysis, we perform an on-the-fly re-normalisation of the observed spectrum, which allows a more accurate comparison of synthetic and observed spectra (Sec.~\ref{sec:comparison_synthetic_spectra_to_observations}) and thus a more accurate stellar label optimisation (see Sec.~\ref{sec:stellar_label_optimissation}).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Initial stellar labels}
\label{sec:initial_stellar_labels}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% https://github.com/svenbuder/GALAH_DR4/blob/main/spectrum_analysis/galah_dr4_initial_parameters.ipynb

Initial values of all stellar labels are needed for creating a first synthetic spectrum. For \vrad, \Teff, \logg, and \vsini we use a combination of sources. Where possible, we use the previous estimates from GALAH DR3 GALAH DR3 \citep{Buder2021} and otherwise those from the GALAH DR4 reduction pipeline (Sec.~\ref{sec:spectroscopic_data_from_galah_observations}). Because of the limited accuracy of the latter for cool stars with $T_\text{eff} < 4000\,\mathrm{K}$ as well as the hottest stars with $T_\text{eff} > 6500\,\mathrm{K}$, we perform a consistency check with photometric information from $\Gaia$ DR3 \citep{Brown2021}, and 2MASS \citep{Skrutskie2006}. For most of the aforementioned cool and hot stars, we therefore prefer the parameters from the \Gaia DR3 photometric pipeline GSP-Phot \citep{Andrae2022,Fouesneau2022}.

In selected cases, we further adjust the starting parameters towards reasonable limits, for example for hot stars which are likely to be young and close to Solar [Fe/H]. Furthermore, we recalculate initial \vmic based on Eq.~\ref{eq:vmic_initial} and limits rotational broadening values to $3 \leq v \sin i \leq 10\,\mathrm{km\,s^{-1}}$ for stars below $T_\text{eff} = 5500\,\mathrm{K}$ and $3 \leq v \sin i \leq 20\,\mathrm{km\,s^{-1}}$ for hotter stars. The explicit choices of starting values for \Teff, \logg, \feh, \vmic, and \vsini are described in our \href{https://github.com/svenbuder/GALAH_DR4/blob/main/spectrum_analysis/galah_dr4_initial_parameters.ipynb}{online repository} and are depicted in Fig.~\ref{fig:initial_parameters}.

Based on the value of \feh we apply an offset to the $\mathrm{\alpha}$-elements O, Mg, Si, Ca, and Ti within our wavelength range. The initial value is 0.4 for $\mathrm{[Fe/H]} < -1$, 0.0 for $\mathrm{[Fe/H]} > 0$, and $-0.4\cdot \mathrm{[Fe/H]}$ for $-1 \leq \mathrm{[Fe/H]} \leq 0$. All other abundances are initialised at $\mathrm{[Fe/H]} = 0$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Comparison of synthetic spectra to observations}
\label{sec:comparison_synthetic_spectra_to_observations}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The major aim of our spectroscopic analysis is to predict the best set of stellar labels by minimising the uncertainty-weighted difference of observed and synthetic spectra. In this section, we describe several important steps to enable the pixel-level comparison of the higher resolution, oversampled synthetic spectra created with the neural networks from Sec.~\ref{sec:interpolating_synthetic_spectra_with_neural_networks} and the observational data at actually measured resolution and sampling (presented in Sec.~\ref{sec:spectroscopic_data_from_galah_observations}).

\subsubsection{Downgrading of synthetic spectra to observed resolution}

Because dedicated line-spread-function measurements are available for every spectrum (see Sec.~\ref{sec:spectroscopic_data_from_galah_observations}), we use this information to downgrade our synthetic spectra to the measured resolution of each observations. We then interpolate the over-sampled synthetic spectrum onto the observed wavelength.

\subsubsection{On-the-fly re-normalisation of observed spectrum}

Measurements of the GALAH flux and flux uncertainty are reported in counts by the reduction pipeline. To compare with our synthetic spectra, which are normalised to the continuum, we fit an outlier-robust polynomial function to the ratio of observed and synthetic spectrum and re-normalise our observed spectra and their uncertainties via this normalisation function.

This specific approach is similar to the internal routine of \textsc{SME} \citep{Piskunov2017} and has the important advantage, that no continuum points have to be defined. This is advantageous, because we try to cover the full parameter range of FGKM stars for which positions of continuum points -- corresponding to 1 on a (pseudo-)continuum-normalised spectrum -- differ significantly or for which continuum points may not even be present (as is the case for M stars).

We make two additional adjustments to the reduced spectra, which come in the form of counts and uncertainty per wavelength, $f_\lambda$ and $\sigma_{f,\lambda}$.

\begin{figure}[ht]
\centering
\includegraphics[width=\textwidth]{figures/Nuisance_example.png}
\caption{
\textbf{Example of normalisation for GALAH DR4 for a model spectrum that is selected during the label optimisation.}
\textbf{Panel (a):} Observed spectrum (counts) of star 2MASS XYZ.
\textbf{Panel (b):} Ratio (blue) of observed spectrum and model spectrum as well as Chebychev polynomial fit (orange).
\textbf{Panel (c):} Normalised observed spectrum (black) compared to the model spectrum (blue). Residuals (red) can then be used as input for the likelihood function.
}
\label{fig:ratio_normalisation}
\end{figure}

As we compare the observation to model spectra, we do not have to restrict ourselves to an a priory normalisation, but can take into account the residual information on the continuum in parts of the spectra. For each model spectrum that we compare to, we therefore perform a normalisation by fitting a Chebyshev polynomial with outlier clipping to the ratio of model and observation (see Fig.~\ref{fig:ratio_normalisation}). This allows us to both overcome previous shortcomings of the synthetic analysis in GALAH+ DR3 \citep{Buder2021}, which had to be restricted to small wavelength segments and assumed a linear relation for those. Our new approach allows us to properly assess the structure of deep and steep molecular features for cool stars, which dominate spectra of cool stars and carry significant information on \Teff as well as \vrad.

% \SB{Describe here the tests we do to make sure this actually provides a smooth transition between the different labels. Tests of the Cannon models show, that they can reproduce the spectra and their labels within for example $1\K$ \Teff, $0.01\dex$ \logg, and $0.01\dex$ \feh for the grid edges. But more thorough testing is needed.}
% \SB{Also keep in mind the issues found for \TheCannon with only 2 models applied to RAVE \citep{Casey2017}.}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Stellar label optimisation}
\label{sec:stellar_label_optimissation}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

In up to four major loops, we optimise the radial velocities and all other stellar labels and report a) their values, b) their co-variances, c) the best fit synthetic and re-normalised spectra along with their uncertainties and masks that indicate which pixels were used in the final optimisation.

Starting from the initial values, a first synthetic spectrum is computed and compared with the observation in order to assess the initial radial velocity. This is done by applying the \textsc{scipy.signal.find\_peaks} algorithm on a the residuals\footnote{We use the inverse of the residuals that were normalised with the smallest residual values.} of non-shifted observed and synthetic spectra, when the latter is shifted by $v_\text{rad} = -1000..(2)..1000\kms$ (see Fig.~\ref{fig:181221003101356_single_fit_rv}a). If no peak is found, the initial \vrad value is used hereafter. If more than one peak is found (see Fig.~\ref{fig:181221003101356_single_fit_rv} with \Gaia DR3 agreeing with the systemic radial velocity), the two strongest peaks are reported and trigger a stellar label estimation assuming binary star (Sec.~\ref{sec:binary_analysis}. For the purpose of the single star analysis, a narrower search is conducted around the highest peak with a \vrad shift of $-20.00..(0.04)..20.00\kms$ around said peak by fitting a Gaussian function to the inverse of the residuals that were normalised with the smallest residual values (see Fig.~\ref{fig:181221003101356_single_fit_rv}c). The mean of this fit and its uncertainty are reported by the pipeline.

\begin{figure}[hbt]
\centering
\includegraphics[width=\textwidth]{figures/181221003101356_single_fit_rv.png}
\caption{\textbf{Output of the radial velocity fitting module.} \textbf{Panel a)} shows the initial broad search on a \vrad array of $-1000..(2)..1000\kms$. In the case of 2MASS J06084657-7815235, two peaks (yellow, dashed) are visible for this line-splitting spectroscopic binary. \textbf{Panel b)} shows the same plot, but overlaid with the GALAH DR4 reduction pipeline (red) and \Gaia DR3 (blue, dashed) estimates. \textbf{Panel c)} shows the narrow window of $-20.00..(0.04)..20.00\kms$ around the highest peak and the Gaussian fit (yellow) to it.}
\label{fig:181221003101356_single_fit_rv}
\end{figure}

The centerpiece of our optimisation is the \textsc{scipy.optimise} routine \textsc{curve\_fit} module \citep{scipy}, which we call with counts and uncertainties (our absolute sigmas) as input for a placeholder function that self-consistently re-normalises the observed spectrum. We estimate the labels via the least squares optimisation within less than $10^4$ iterations and a desired relative error (\texttt{xtol}) below 0.0001.

For the each optimisation loop, a new, best-fit 3D bin and neural network is identified via a grid search in the \TLF dimensions with \textsc{sklearn.cKDtree}. If the stellar labels that are being fitted have changed (for example if an element is deemed not detectable for the new 3D bin), the label and its value is either deleted or initialised with $\mathrm{[X/Fe]} = 0$.

While the optimisation has not converged (the final parameters \TLF are not within the current 3D bin), the optimisation is repeated, starting with the previous best-fit parameters as starting guesses.

\begin{figure*}[ht]
\centering  
\includegraphics[width=\textwidth]{figures/example_masking_sun.png}
\caption{\textbf{Examples of masks applied to unreliable pixels for the spectrum fitting, that is the minimisation of residuals (red) between observation (black) and synthesis (blue).} \textbf{Panel a)} showing a strong synthetic line, where no line is observed in the Sun. \textbf{Panel b)} showing an observed line without any line being synthesised. \textbf{Panel c)} showing significant disagreement between the two observed lines and the synthesis.} \label{fig:example_masking_sun}
\end{figure*}

\subsubsection{Which labels are optimised?} \label{sec:which_labels_are_optimised}

%% This paragraph is based on the combination of 
%% spectrum_interpolation/galah_dr4_grid_interpolation_recommend_labels.ipynb
%% and
%% spectrum_analysis/galah_dr4_spectrum_analysis_single.ipynb

As part of the synthetic grid computations, we have perturbed each label individually to our chosen maximum and minimum ranges (see Sec.~\ref{sec:spectrum_grid}). This allows us to also judge which stellar labels to fit for each given star. We choose to fit a stellar label, if either of the two cases applies to said label for the GALAH wavelength range when neglecting the cores of the Balmer lines: Does the spectrum between minimum and maximum label value at any pixel change more than a certain threshold (0.07 of the normalised spectrum)? Does the spectrum between minimum and maximum label value change by more than 0.005 of the normalised spectrum for at least 25\% of the spectrum? While the first case is constructed for atomic lines, such as \ion{Li}{i} 6708, the second case is addressing in particular molecular lines like the $\mathrm{C_2}$ and $\mathrm{CN}$ lines. For spectra that are missing the infrared arm (CCD4) we exclude the otherwise possibly fit labels for N, O, L, and Rb.

Initial tests of the pipeline have revealed that in cases where the initial parameter guesses are deviating significantly from the final ones, several elemental abundance estimates were shifted towards their boundaries, leading to a masking of their elemental abundances lines by the masking module (Sec.~\ref{sec:masking_of_unreliable_wavelength_regions}) at the beginning of each optimisation loop. To minimise this effect, we therefore shift the interim abundance values towards the narrow label boundaries. In practise, we this limit the initial and interim abundances to 1.05..3.26 for A(Li), $\mathrm{[X/Fe]} = -0.5..1.0$ for C, N, O, Y, Ba, La, Ce, and Nd, and $\mathrm{[X/Fe]} = -0.5..0.5$ for all other elements before optimising them again. For warm and hot stars ($T_\text{eff} > 6000\K$), this effect was seen to effect multiple abundances, such that we needed to implement a zeroing of all abundances (except Lithium) for stars above $6000\K$, which would on average be expected to be young and have a solar-like composition.

\subsubsection{Masking of unreliable wavelength regions} \label{sec:masking_of_unreliable_wavelength_regions}

Not all pixels of the observed or synthetic spectra might prove useful for estimating reliable stellar labels. Observations can include bad pixels/patterns and incorrect corrections (for example of telluric or sky lines). Flux predictions of synthetic spectra are only as good as the input physics (limited for example for specific lines via uncertain oscillator strengths).

% Based on https://github.com/svenbuder/GALAH_DR4/blob/main/spectrum_analysis/galah_dr4_solar_analysis.ipynb
To minimise the influence of inaccurate synthetic pixel predictions, we have compared a 2dF-HERMES observation of the asteroid 4~Vesta and a high-quality  Solar spectrum by \citet{Hinkle2000} with the flux that would be predicted through our pipeline for a star with Solar labels ($T_\text{eff} = 5772\K$, $\log g = 4.438\dex$, $\mathrm{[Fe/H]} = 0.00\dex$, $v_\text{mic} = 1.06\kms$, $v \sin i = 1.6\kms$, $v_\text{mac} = 4.2\kms$ \citep{Prsa2016, Jofre2017}, and $\mathrm{[X/Fe]} = 0.00\dex$ for the default Solar abundance pattern for \marcs by \citet{Grevesse2007}).

We have identified all lines that showed differences of the normalised flux of more than $0.1$, lines where either a synthetic line or an observed one was completely missing, or lines that were significantly misaligned. Examples of this \href{https://github.com/svenbuder/GALAH_DR4/blob/main/spectrum_analysis/spectrum_masks/solar_spectrum_mask.fits}{list} of masks are shown in Fig.~\ref{fig:example_masking_sun}. To avoid the influence of bad spectrum regions with an observational origin, we mask pixels where the synthetic and re-normalised observed spectrum differ by more than $5\sigma$ or a flux of 0.3 (0.4 before the initial optimisation). To avoid the masking of lines that are vital for our spectroscopic analysis, we have created a \href{https://github.com/svenbuder/GALAH_DR4/blob/main/spectrum_analysis/spectrum_masks/vital_lines.fits}{list} with segments of such lines that is mainly based on the previous element masks from GALAH DR3 \citep{Buder2021}. The final mask of pixels to use for the optimisation then includes all vital line regions and those wavelengths that are not unreliable in the synthesis show a too strong disagreement between observation and synthesis.

In addition to this default masking, we exclude pixels for each major iteration, for which the flux of observation and synthetis differ by more than $5 \sigma$ and 0.3 of the normalised flux and by more than 1 for the vital line regions.

We further indirectly take into account the currently less constrained molecular data for cool stars in optical spectra, in particular towards the blue \citep[e.g.][]{Rains2021}. For presumably cool stars (with initial $T_\text{eff} < 4100\,\mathrm{K}$), we therefore double the observational uncertainty of the blue arm.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{SINGLE STAR ANALYSIS (ALLSTAR)}
\label{sec:allstar_analysis}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

After the \textit{allspec} module (Sec.~\ref{sec:allspec_analysis}) was used to estimate spectroscopic labels for all spectra, we use the \textit{allstar} module to co-add spectra and analyse one spectrum per star while taking into account photometric and astrometric information to constrain the surface gravities. This approach was already very successfully applied for GALAH DR3 \citep{Buder2021} with \Gaia DR2 distances \citep{BailerJones2018} to overcome spectroscopic degeneracies. For the co-adding, we test if the radial velocity estimates of individual exposures agree within $2\sigma$. Below this threshold, we apply no radial velocity correction and fit a gloval radial velocity. Above this threshold (which is useful for spectroscopic binaries of type 1 without line splitting as shown in Fig.~\ref{fig:examples_flag_sp_2}), we apply a radial velocity correction before the co-adding.

\begin{figure}[ht]
 \centering
 \includegraphics[width=\textwidth]{figures/examples_flag_sp_2.png}
 \caption{\textbf{Example of the radial velocity evolution over time for a spectroscopic binary (SB) of type I (no line split)}.}
 \label{fig:examples_flag_sp_2}
\end{figure}

To speed up computation, we use the mean results of the \textit{allspec} analyses as initial stellar labels. All other methodology of the comparison of synthetic spectra to observations (Sec.~\ref{sec:comparison_synthetic_spectra_to_observations} and label optimisation (Sec.~\ref{sec:stellar_label_optimissation}) apply also to this module, with the exception of the optimisation of \logg. Contrary to the \textit{allspec} approach, we do not fit \logg in thi module, but estimate the logarithmic surface gravity, $\log g$, as a combination of its definition ($g \propto \frac{\mathcal{M}}{\mathcal{R}^2}$) and the Stefan-Boltzmann law relative to the Solar values:
\begin{equation}
\log g = \log g_\odot + \log \frac{\mathcal{M}}{\mathcal{M_\odot}} + 4 \log \frac{T_\mathrm{eff}}{T_\mathrm{eff,\odot}} - \log \frac{L_\mathrm{bol}}{L_\mathrm{bol,\odot}} \label{eq:logg}
\end{equation}

While we can use our spectroscopically determined $T_\mathrm{eff}$, the other values have to be estimated through models or non-spectroscopic information. The logarithmic bolometric luminosity, $L_\mathrm{bol}$, can be estimated from the bolometric magnitude, such that $\log \frac{L_\mathrm{bol}}{L_\mathrm{bol,\odot}} = -0.4 \cdot \left(M_\mathrm{bol} - M_\mathrm{bol,\odot} \right)$. The bolometric magnitude can be estimated from any given apparent magnitude, if we correct the latter by the distance modulus, bolometric correction, and extinction. Because for essentially all stars of GALAH DR4, we have outstanding infrared magnitudes available which suffer less from (uncertain) extinction corrections, we continue to chose $K_S$ as the magnitude to estimate our bolometric magnitudes and luminosities via
\begin{equation}
M_\mathrm{bol} = K_S - 5\cdot \log \frac{D_\varpi}{10} + BC(K_S) - A(K_S). \label{eq:mbol}
\end{equation}

While the values for $K_S$, $D_\varpi$, and $A(K_S)$ are readily available (see Sec.~\ref{sec:non-spec_data}), we need to estimate the bolometric correction from tabulated values using the routines provided by \citet{Casagrande2018}:
\begin{equation}
BC(K_S) = f(T_\mathrm{eff}, \log g, \mathrm{[Fe/H]})
\label{eq:bc_ks}
\end{equation}
We choose to assume an extinction value of $E(B-V) = 0\,\mathrm{mag}$ for this particular interpolation and post-correct the value by $A(K_S)$ our actual extinctions can exceed the tabulated values of $E(B-V) = 0.72\,\mathrm{mag}$ by \citet{Casagrande2018} and our available $E(B-V)$ values from \citet{Schlegel1998} are upper limits that can overestimate the actual extinction of our observed targets.

Because of the appearance of $\log g$ in Eq.~\ref{eq:bc_ks}, we iterate the calculation of $BC(K_S)$ and subsequently $\log g$ up to four times or until the latter value changes less than $0.02\,\mathrm{dex}$ between iterations. Similarly, we need to estimate the stellar masses (and ages as a byproduct) from tabulated values, that is,
\begin{equation}
\mathcal{M}, \tau = f(T_\mathrm{eff}, \log g, \mathrm{[Fe/H]}, L_\mathrm{bol,\odot})
\label{eq:mass_age}
\end{equation}
For this on-the-fly estimate of masses and ages we use an earlier version of the \texttt{ELLI} code by \cite{Lin2018} for a likelihood-weighted estimate with default uncertainties of $100\,\mathrm{K}$, $0.25\,\mathrm{dex}$, $0.2\,\mathrm{dex}$, and an average uncertainty of $L_\mathrm{bol,\odot}$ from propagated uncertainties of Eq.~\ref{eq:mbol}.

We interpolate over the default tables of {\sc parsec+colibri} isochrones \citep{Bressan2012, Marigo2017} from that cover the logarithmic ages of $\log (\tau~/~\mathrm{Gyr}) = 8.00..(0.01)..10.18$ by default and metallicities $\mathrm{[M/H]} = -2.75..(0.25)..-0.75$ as well as $\mathrm{[M/H]} = -0.6..(0.1)..0.7$. For open clusters with age estimates below $1\,\mathrm{Gyr}$ as well as unevolved stars that are more luminous than expected from the oldest cool main sequence isochrone with matching $\mathrm{[M/H]}$, we sample $\log (\tau~/~\mathrm{Gyr}) = 6.19..(0.01)..10.18$. We exclude hot stars above $10\,000\,\mathrm{K}$ as well as extremely evolved stars ($\log g > 6\,\mathrm{dex}$ or $J - K_S > 2\,\mathrm{mag}$) as they fall far outside our spectroscopic pipeline range. We convert between the theoretical [M/H] and our measured [Fe/H] as well as $\mathrm{[\upalpha/Fe]}$ via the correlation by \citet{Salaris2006}, $\mathrm{[M/H]} = \mathrm{[Fe/H]} + \log\left(10^{\mathrm{[\upalpha/Fe]} \cdot 0.694 + 0.306} \right)$.

\begin{figure*}[ht]
\centering
\includegraphics[width=\textwidth]{figures/dlogg_spec_plx.png}
\caption{\textbf{Comparison of spectroscopic and photometric \logg estimates of the \textit{allspec} analysis}
\textbf{Panel a)} shows the distribution of spectroscopic \logg and \Teff from the \textit{allspec} module.
\textbf{Panel b)} shows the distribution of the same \Teff and photometric \logg.
\textbf{Panel c)} shows the difference of photometric \logg and spectroscopic \logg as a function of photometric \logg. Red error bars indicate the $1\sigma$ percentiles of this difference in $0.5\,\mathrm{dex}$ bins.} \label{fig:dlogg_spec_plx}
\end{figure*}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{BINARY STAR ANALYSIS (BINARY)}
\label{sec:binary_analysis}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% spectrum_analysis/galah_dr4_spectrum_analysis_binary.ipynb

This module is motivated by the extensive study of GALAH binary star spectra by \citet{Traven2020} and our ability to model the full spectrum via neural networks. It is activated, if the post-processing of a spectrum for binary signatures in the residual spectra or differences to \Gaia DR3 radial velocities (Sec.~\ref{sec:trigger_binary_module}) warrant a closer inspection of binarity.

% In our strictly spectroscopic implementation, we only use the stellar GALAH spectra and the two radial velocity peaks identified in the radial velocity optimisation step (see Fig.~\ref{fig:181221003101356_single_fit_rv}) of the single star analysis (Sec.~\ref{sec:allspec_analysis}).

\SB{The module is still in development, but already now delivers at least useful radial velocity estimates \texttt{rv\_comp\_1} and \texttt{rv\_comp\_2} as well as an overall $\chi^2$ of a binary spectrum, as shown in Fig.~\ref{fig:examples_flag_sp_3}.}

\begin{figure}[ht]
 \centering
 \includegraphics[width=\textwidth]{figures/examples_flag_sp_3.png}
 \caption{\textbf{Examples the spectrum a line-splitting binary (SB type II) which is better fit with our binary fitting algorithm.}} \label{fig:examples_flag_sp_3}
\end{figure}

\SB{In the current implementation, we superimpose two synthetic spectra with a relative flux contribution factor \texttt{f\_contr} between 0 and 1. In addition to fitting this flux contribution ratio, we fit $T_{\text{eff},s}$, $\log g_s$, $v_{\text{mic},s}$, $v_{\sin i,s}$ for  synthetic spectra of two stars $s$ with the same [Fe/H] to the observed spectrum.}

\SB{Because we know that the stars most likely share not only the same [Fe/H], but also age $\tau$, another implementation could be to fit a system age and [Fe/H] and two different masses $M_s$. In this case, $T_{\text{eff},s}$ and $\log g_s$ would be interpolated from the PARSEC isochrones for a given age, mass, and [Fe/H] combination. This could be tricky though because of the turn-off region which may cause local $\chi^2$ minimum.}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{POST-PROCESSING}
\label{sec:post_processing}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

After the \textit{allspec} (Sec.~\ref{sec:allspec_analysis}), \textit{allstar} and (Sec.~\ref{sec:allstar_analysis}) modules have been run for a night, a post-processing routine is used to estimate additional parameters from the residuals of the spectra (Sec.~\ref{sec:residual_analysis}), estimate and validate accuracy and precision uncertainties (Sec.~\ref{sec:uncertainty}) and perform quality assurance tests on a global scale (\texttt{flag\_sp}, see Sec.~\ref{sec:flag_sp}) as well as for the individual abundances of elements X (\texttt{flag\_x\_fe}, see Sec.~\ref{sec:flag_x_fe}).

\subsection{Analysis of spectral residuals} \label{sec:residual_analysis}

\subsubsection{Binary signatures to trigger the \textit{binary} module} \label{sec:trigger_binary_module}

The residual spectrum of our best fitting single star analysis can help us to identify a second flux contributor to the observed spectrum. In our case, there are two points in the analysis, where we can identify such an influence. Firstly, the residuals are visible in the $\chi^2$ distribution as a function of radial velocity shifts (see Fig.~\ref{fig:181221003101356_single_fit_rv}). While a single star would only show one peak (saved in \texttt{rv\_comp\_1}), a binary system like 2MASS J06084657-7815235 shows a second peak ($-70\,\mathrm{km\,s^{-1}}$ in addition to $74\,\mathrm{km\,s^{-1}}$) that is saved in the \texttt{rv\_comp\_2}. Secondly, we perform an automatic search for re-occuring residuals as a function of radial velocity for a few selected lines. We chose the combination of strong lines in the spectra (Balmer lines, Fe lines at 4890 and $4891\,\text{\AA}$, Ni at $6644\,\text{\AA}$) as well as those with the largest expected wavelength shift in the infrared detector (O triplet att $7772-7775\,\text{\AA}$ as well as Mg at $7692\,\text{\AA}$). If we find several peaks with a reasonably similar radial velocity, the likely $X \in {16,50,84}^\text{th}$ percentiles of this radial velocities are saved in \texttt{sb2\_rv\_X}\footnote{\SB{Should we better run the Gaussian fitting to residuals in RV space, as we do during the RV estimation?}}

Because we radial velocities from the \Gaia radial velocity spectrometer \citep{Katz2022} are reported in \Gaia DR3 for 94\% (774\,914) of the stars observed for GALAH DR4, we can also compare the radial velocity estimates. For 6\% (50\,577) of our stars, we find difference with respect to \Gaia DR3 beyond $10\,\mathrm{km\,s^{-1}}$. For these as well as stars for which we estimate unrealistic \vmic and \vsini below $0\,\mathrm{km\,s^{-1}}$ in \textit{allspec}\footnote{\SB{\textit{allspec} was run without boundary conditions for global parameters and thus also resulted in negative velocities, which are later flagged. \textit{allstar}, however, was run with \vmic and \vsini forced to be above $0\,\mathrm{km\,s^{-1}}$.}} or \vsini above $10\,\mathrm{km\,s^{-1}}$ or identify a secondary component in \texttt{rv\_comp\_2} and \texttt{sb2\_rv\_X}, we trigger the run of the \textit{binary} module (see Sec.~\ref{sec:binary_analysis}).

\begin{figure*}[ht]
 \centering
 \includegraphics[width=\textwidth]{figures/example_dibs_06453479-0102137.png}
 \caption{\textbf{Example of interstellar diffuse band (DIB) and interstellar K measurements for 2MASS J06453479-0102137 with $E(B-V) = 0.84\,\mathrm{mag}$ from \citet{Schlegel1998}.}. Shown are the observation (black) and stellar fit (blue) as well as a Gaussian fit (red) to the residual (orange), resulting in an estimate of the equivalent width (EW) as well as radial velocity.} % 140314005201392
 \label{fig:example_dibs_06453479-0102137}
\end{figure*}

\subsubsection{Post-correction of {log\textit{g}} for \textit{allspec} results}

While we estimate logarithmic surface gravities \logg solely from spectra in the \textit{allspec} results, we also perform a post-processing estimate where we employ the methodology of Sec.~\ref{sec:allstar_analysis} while fixing all other stellar parameters. While planned as an initial test, it clearly confirmed the previous conclusions of GALAH DR1-DR3 that the spectroscopic information in HERMES spectra to estimate \logg is not sufficient for the majority of the parameter space. We show the spectroscopic \logg in Fig.~\ref{fig:dlogg_spec_plx}a and the photometric \logg and their difference in Figs.~\ref{fig:dlogg_spec_plx}b and c, respectively.

We see an overall good agreement of both \logg estimates for stars between $4250 < T_\text{eff} < 6500\,\mathrm{K}$. Hotter stars show a strong dispersion of spectroscopic \logg due to limited information from fewer and shallower lines. Cooler stars show a significant trend towards much lower \logg for main sequence stars and much higher \logg for cool evolved stars up to an order of $\Delta \log g$ of $1\,\mathrm{dex}$. This trend was previously seen in GALAH DR2 \citep{Buder2018} and is believed to be caused by the onset of molecular absorption features which suppress the continuum for almost the entire HERMES wavelength range (see for example Fig.~\ref{fig:ratio_normalisation}), thus introducing several degeneracies\footnote{\SB{Get back to thi and include the private communication with Charlie Conroy on the \logg trends for cool stars.}}. In addition, we can notice a significantly lower precision of the spectroscopic \logg in comparison to the excellent precision of photometric \logg, for example of the red clump stars.

At closer inspection, we notice several trends in Fig.~\ref{fig:dlogg_spec_plx}a. Most notably, we see noding patterns along the \Teff and \logg grids where the \textit{allspec} module switches between different neural network models. Our investigation of these noding effects is addressed in Sec.~\ref{sec:caveats}. In comparison to Fig.~\ref{fig:dlogg_spec_plx}b, where a clear same mass binary sequence is showing just above the cool main sequence, we do not see such a sequence in Fig.~\ref{fig:dlogg_spec_plx}a. The difference between spectroscopic and photometric \logg will therefore be useful to identify photometric binaries at least for the high quality spectra (where \logg precisions are below the single to binary system offset of $\Delta \log g = 0.3\,\mathrm{dec}$), as discussed in Sec.~\ref{sec:flag_sp}.

\SB{Also think about what we do for the 15\,319 stars for which we cannot calculate a photometric \logg due to missing information from \Gaia. For those we only have \textit{allspec} \texttt{logg\_spec} \logg and neither \textit{allspec} nor \textit{allstar} \texttt{logg} (or any parameters for \textit{allstar} at all).}

\subsubsection{Interstellar absorption}

Because we can create synthetic stellar spectra for the full wavelength range, we can now also trace interstellar absorption in the residuals of observed spectra. By default, we try to calculate the equivalent width via Gaussian fits to the three diffuse interstellar bands (5780.59, 5797.19, $6613.66\,\text{\AA}$) with central wavelengths identified by \citet{Vogrincic2023} as well as for interstellar K ($7698.9643\,\text{\AA}$), see Fig.~\ref{fig:example_dibs_06453479-0102137}. We report the equivalent widths \texttt{eq\_x}, standard deviations \texttt{sigma\_x} and radial velocities \texttt{rv\_x} for \texttt{x} in \texttt{k\_is} for interstellar K and \texttt{x} in \texttt{DIB\_5780}, \texttt{DIB\_5797}, and \texttt{DIB\_6613}.

\subsubsection{Emission estimates for the Balmer lines}

The difference between synthetic and observed Balmer line absorption holds valuable information both on emission stars as well as the known inaccuracy of the synthetic Balmer lines and possibly even information on unresolved binary systems (Sayeed et al., in prep.) as well as masses for evolved stars \citep{Bergemann2016}. We therefore perform a trapezoidal integration around the Balmer line at $4861.3230$ and $6562.7970\,\text{\AA}$ whose values we report in \texttt{ew\_h\_beta} and \texttt{ew\_h\_alpha}. By default we integrate in a window of $\pm 0.75$ and $1.25\,\text{\AA}$for $\text{H}_\beta$ and $\text{H}_\alpha$, respectively, and increase this window to $5\,\text{\AA}$ if the average observed, normalised flux within $\pm 0.5\,\text{\AA}$ of the Balmer line core exceeds 1. An example of such a star is shown in Fig.~\ref{fig:examples_flag_sp_1}, for which we measure a residual EW of $1.09\,\text{/AA}$.

\begin{figure}[ht]
 \centering
 \includegraphics[width=\textwidth]{figures/examples_flag_sp_1.png}
 \caption{\textbf{Example of a stars with clear emission in the Balmer lines (here $\mathrm{H_\alpha}$) and raised major quality flag \texttt{flag\_sp} for emission.}} \label{fig:examples_flag_sp_1}
\end{figure}

\begin{figure}[ht]
 \centering
 \includegraphics[width=\textwidth]{figures/emission_young_stars.png}
 \caption{\textbf{Distribution of residual equivalent width between observation and synthesis in the \Gaia DR3 color-absolute magnitude diagram ($G_{BP}-G_{RP}$ vs. $M_G$) for cool dwarfs.} Balmer lines in emission result in negative color values, as is the case for most young stars that are more luminous than the cool main sequence. \SB{Should we point out the interesting sequence of binary MS around $M_G \sim 7\,\mathrm{mag}$?}} \label{fig:emission_young_stars.png}
\end{figure}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Uncertainty estimation and validation}
\label{sec:uncertainty}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{table}
\centering
\caption{List of accuracy and representative precision uncertainties for stellar parameters of GALAH DR4. Precision values are extracted from our empirical precision uncertainty estimates for a spectrum with $SNR = 50$ of a star with stellar parameters \Teff, \logg, \feh.}
\label{tab:accuracy_precision}
\begin{tabular}{ccc}
\hline \hline
Parameter / Unit & Accuracy & Precision ($SNR = 50$)\\
\hline
$T_\text{eff}~/~\mathrm{K}$          & 66     & X.X \\
$\log (g~/~\mathrm{cm\,s^{-2}})$     &  0.042 & X.X \\
$\mathrm{[Fe/H]}~/~\mathrm{dex}$     &  0.064 & X.X \\
$v_\text{mic}~/~\mathrm{km\,s^{-1}}$ &  0.28  & X.X \\
$v \sin i~/~\mathrm{km\,s^{-1}}$     &  1.4   & X.X \\
$v_\text{rad}~/~\mathrm{km\,s^{-1}}$ &  0.15  & X.X \\
\hline
\end{tabular}
\end{table}

\subsubsection{Accuracy estimation and validation} \label{sec:uncertainty_accuracy}

Estimating the accuracy of spectroscopic measurements has always been a complicated endeavour, because there are no universal benchmark sets for all parameters. Subsequently, we there describe the numerous comparisons that we have performed for both stellar parameters (\Teff, \logg, \feh, \vmic, \vsini, and \vrad) as well as the elemental abundance measurements. Due to the limited coverage of benchmark literature, we continue to apply a universal accuracy estimate for the stellar parameters and no accuracy estimate for the elemental abundances \citep[as for GALAH DR3][]{Buder2021}.

\SB{Describe shifts applied to the parameters and abundances. Most important is the increase of $\mathrm{[Fe/H]}$: Here we had to apply a piece-wise shift, described in Eq.~\ref{eq:piecewise_feh_shift}}
\begin{align}
\Delta \mathrm{[Fe/H]}=
\begin{cases}
0.049 \qquad &\mathrm{for~[Fe/H]} \geq 0,\\
0.149 \qquad &\mathrm{for~[Fe/H]} \leq -1,\\
0.049 - 0.1 \cdot \mathrm{[Fe/H]} \qquad &\text{else}\\
\end{cases} \label{eq:piecewise_feh_shift}
\end{align}



\begin{figure*}[ht]
 \centering
 \includegraphics[width=\textwidth]{figures/galah_dr4_age_xfe_trends_solar_twins.png}
 \caption{\textbf{Solar twins}}
 \label{fig:galah_dr4_age_xfe_trends_solar_twins}
\end{figure*}


\SB{Still to Do: Wide Binaries for Fig.~\ref{fig:galah_dr4_zeropoint_checks}}

Fig.~\ref{fig:galah_dr4_validation_parameter_accuracy_allstar} for stellar parameters and Fig.~\ref{fig:galah_dr4_zeropoint_checks} for abundances.

\begin{figure*}[ht]
 \centering
 \includegraphics[width=\textwidth]{figures/galah_dr4_validation_parameter_accuracy_allstar.png}
 \caption{\textbf{Accuracy of the main stellar parameters \Teff, \logg, \feh, \vmic, \vsini, and \vrad for GALAH DR4.}. Each panel shows the comparison to literare (DR4 - literature). Comparisons are performed for the \Gaia FGK Benchmark stars (red), APOGEE DR17 (blue), \logg inferred from asteroseismic measurements (orange) and \Gaia DR3 radial velocities (purple).}
 \label{fig:galah_dr4_validation_parameter_accuracy_allstar}
\end{figure*}

\begin{figure*}[ht]
 \centering
 \includegraphics[width=\textwidth]{figures/galah_dr4_vrad_gaia_dr3.png}
 \caption{\textbf{Comparison of radial velocities between GALAH DR4 and \Gaia DR3.}
 \textbf{Panel a)} shows the difference of radial velocities as function of \Gaia's $G$ photometry.
 \textbf{Panel b)} shows a histogram of the difference with two Gaussian distributions (with same mean) fitted to them to estimate a more robust, that is binary independent, radial velocity difference.
 \textbf{Panel c)} shows the difference of radial velocities as function of radial velocity, showing the systematic scatter introduced by binaries.
}
 \label{fig:galah_dr4_vrad_gaia_dr3}
\end{figure*}



\begin{figure*}[ht]
 \centering
 \includegraphics[width=\textwidth]{figures/galah_dr4_zeropoint_checks.png}
 \caption{\textbf{Zeropoint estimates of elemental abundances for GALAH DR4.}. Each panel shows the comparison to literare (DR4 - literature) for VESTA (blue), \Gaia FKG Benchmark Stars (orange), Stars with $\vert \mathrm{[Fe/H]} \vert \leq 0.1$ closer than $D_\varpi < 0.5\,\mathrm{kpc}$ (red), as well as the overlap with APOGEE DR17 (purple).}
 \label{fig:galah_dr4_zeropoint_checks}
\end{figure*}

\begin{itemize}
    \item \Gaia FGK Benchmark stars \citep{Jofre2018} Fig.~\ref{fig:galah_dr4_validation_parameter_accuracy_allstar}a-c
    \item IRFM \citep{Casagrande2020}
    \item K2/TESS \citet{Zinn2020} Fig.~\ref{fig:galah_dr4_validation_parameter_accuracy_allstar}b
    \item APOGEE DR17 Fig.~\ref{fig:galah_dr4_validation_parameter_accuracy_allstar}a-f
    \item \Gaia DR3 for \vrad Fig.~\ref{fig:galah_dr4_validation_parameter_accuracy_allstar}f
    \item Globular Clusters for low [Fe/H] accuracy
    \begin{itemize}
        \item \citet{Carretta2009, Carretta2009b}
        \item Omega Cen \cite{Johnson2010}
        \item M30 (Gruyters?)
    \end{itemize}
    \item Abundance Zeropoints
    \begin{itemize}
        \item VESTA
        \item APOGEE DR17
        \item  M~67, Ruprecht~147 and a few others cover stars across several evolutionary stages. Check them roughly (could also be problematic because of atomic diffusion etc.)
    \end{itemize}

\end{itemize}

\subsubsection{Precision estimation and validation} \label{sec:uncertainty_precision}

\begin{itemize}
    \item Fig.~\ref{fig:galah_dr4_precision_parameters} and \ref{fig:galah_dr4_precision_abundances}
    \item \SB{Create Table with overall scatter values for individual elements based on:}
    \item Covariance uncertainties
    \item Repeat observations
    \item Scatter in open clusters.
    \item Wide binary scatter
\end{itemize}

\begin{figure}[ht]
 \centering
 \includegraphics[width=\textwidth]{figures/galah_dr4_precision_parameters.png}
 \caption{\textbf{Precision monitoring of stellar parameters as a function of SNR for the green CCD2 across for GALAH DR4.}. Each panel shows the behavior for bins of size 10 for the scatter of repeat observations of the allspec runs (blue), covariance uncertainties of allspec (orange) and allstar (red) setups as well scatter of photometric \logg from repeat observations (purple).}
 \label{fig:galah_dr4_precision_parameters}
\end{figure}

\begin{figure*}[ht]
 \centering
 \includegraphics[width=\textwidth]{figures/galah_dr4_precision_abundances.png}
 \caption{\textbf{Precision monitoring of elemental abundances as a function of SNR for the green CCD2 across for GALAH DR4.}. Each panel shows the behavior for bins of size 10 for the scatter of repeat observations of the allspec runs (blue) as well as covariance uncertainties of allspec (orange) and allstar (red) setups. \SB{Missing legend}}
 \label{fig:galah_dr4_precision_abundances}
\end{figure*}

%        \item intrinsic scatter in clusters: M~67, 
%    \end{itemize}
%    \item 
%    \item Globular Clusters:
%    \begin{itemize}
%        \item 
%        \item NGC~104 / 47Tuc
%        \item NGC~288
%        \item NGC~362
%        \item Omega Cen: 
%        \item NGC~1851: \citet{Yong2015}, including CNO
%        \item NGC~6121 / M~4?
%        \item NGC~6362
%        \item NGC~6397
%        \item NGC~7099 / M~30
%        \item We have observed also NGC~4590 / M~68, NGC~5986, NGC~6144, NGC~6541, NGC~6584, NGC~6723, BH~140 and E~3.
%\end{itemize}
%    
%\end{itemize}

\subsubsection{Covariances} \label{sec:uncertainty_covariance}

We also calculate and report the covariances of all fitted labels, see Fig.~\ref{fig:covariance_vesta_arcturus} for VESTA and Arcturus.

\begin{figure*}[ht]
 \centering
 \includegraphics[width=0.49\textwidth]{figures/covariance_vesta.png}
 \hfill
 \includegraphics[width=0.49\textwidth]{figures/covariance_arcturus.png}
 \caption{\textbf{Covariance matrices for VESTA (panel a) and Arcturus (panel b).}}
 \label{fig:covariance_vesta_arcturus}
\end{figure*}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Stellar parameter flags \textsc{flag\_sp}}
\label{sec:flag_sp}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

We have implemented a number of post-processing routines for quality assurance. Here, we describe the major quality flags of global parameters and overall fitting performance. If a spectrum does not pass one of these tests, a unique bit flag will be raised and added to \texttt{flag\_sp}.

The description of the implemented bits/flags for \texttt{flag\_sp} and how often they were raised is listed in Tab.~\ref{tab:flag_sp} and distributions in the Kiel diagram (\Teff and \logg) are shown for each raised bit in Fig.~\ref{fig:flag_sp_overview_allstar} for the \textit{allstar} catalogue.

\SB{Describe how the vsini and vmic flags are quite informative about binarity. Look at the binary main sequence for that!}

\SB{SB2 warning currently often activated for luminous RGB stars. Is that maybe caused by detectable extinction? Inspect more examples and figure out what is going on!}

\SB{Why are the chi2 stars mainly on the RGB? We use a strict cutoff value rather than an SNR dependent one. Maybe implement an SNR dependent on (GBS stars are also all flagged because of this issue)?}

Fig.~\ref{fig:examples_flag_sp_1} and Fig.~\ref{fig:examples_flag_sp_2}

Fig.~\ref{fig:teff_logg_vsini}

\begin{table}[ht]
\centering
\caption{List of major quality flag \texttt{flag\_sp} listing the bit, description and how often the flag was raised for the \textit{allstar} and \textit{allspec} routines. Notes: Multiple bits can be raised for each of the 943\,654 spectra spectra of the  of 827\,288 stars. $(^\star)$ No \logg could be estimated for 15,319 spectra in the post-processing due to missing astrometric information.}
\label{tab:flag_sp}
\begin{tabular}{ccccc}
\hline \hline
Raised Bit & Flag & Description & \textit{allstar} & \textit{allspec} \\
\hline
 & 0 & No flag & 166764 & $\text{633322}^\star$ \\
0 & 1 & Emission & 1576 & 6490 \\
1 & 2 & CCD missing & 221 & 48787 \\
2 & 4 & SB1 & 9292 & 0 \\
3 & 8 & SB2 & 6132 & 31404 \\
4 & 16 & $\chi^2 > 3\sigma$ & 11552 & 58862 \\
5 & 32 & \vsini warning & 17325 & 118341 \\
6 & 64 & \vmic warning & 15495 & 81621 \\
7 & 128 & Triple Binary warning & 0 & 0 \\
8 & 256 & \Teff warning & 0 & 0 \\
9 & 512 & \logg warning & 0 & 0 \\
10 & 1024 & \feh warning & 0 & 0 \\
11 & 2048 & S/N low & 17323 & 89881 \\
12 & 4096 & not converged & 0 & 18042 \\
13 & 8192 & Model extrapolated & 5316 & 56742 \\
14 & 16384 & No Results & 2835 & 6599 \\
\hline
\end{tabular}
\end{table}



\begin{figure*}[ht]
 \centering
 \includegraphics[width=\textwidth]{figures/flag_sp_overview_allstar.png}
 \caption{\textbf{Parameter overview of stars with raised major quality flag \texttt{flag\_sp} for \textit{allstar}.}
 \textbf{Each panel} shows the logarithmic density distribution of stars in the \Teff and \logg plane with blue colormaps. A PARSEC isochrone with $\mathrm{[M/H]}=0$ and $\tau = 4.5\,\mathrm{Gyr}$ is overplotted in orange and the same mass binary main sequence (shifted from the single star one by $\Delta \log g = -0.3\,\mathrm{dex}$) is shown in red. Panel heads denote the bit mask and its description as well as how many times the flag was raised. We neglect distributions with no flag (0), for flags which have not been raised (8,9,11), and for which no results were available (15).} \label{fig:flag_sp_overview_allstar}
\end{figure*}

\begin{figure*}[ht]
 \centering
 \includegraphics[width=\textwidth]{figures/teff_logg_vsini.png}
 \caption{
 \textbf{Overview of rotational velocity of stars}
} \label{fig:teff_logg_vsini}
\end{figure*}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Elemental abundance flags \textsc{flag\_x\_fe}}
\label{sec:flag_x_fe}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{table}
\centering
\caption{List of elemental abundance quality flags \texttt{flag\_fe\_h} for [Fe/H] or \texttt{flag\_x\_fe} for element X.}
\label{tab:flag_x_fe}
\begin{tabular}{ccc}
\hline \hline
Raised Bit & Flag & Description \\
\hline
  & 0 & detection \\ 
0 & 1 & upper limit \\ 
1 & 2 & no measurement available\\
2 & 4 & no convergence\\
3 & 8 & measurement above limit\\
4 & 16 & measurement below limit\\
5 & 32 & measurement issue of CNO \\
% problematic_cfe = (
%     # [C/N] < -1 for non-giants
%     (
%         (data['c_fe'] - data['n_fe'] < -1) & # [C/N] < -1
%         ~((data['logg'] < 3.5) & (data['teff'] < 5500)) # not_giant
%     ) |
%     # No [N/Fe] for non-giants
%     (
%         (data['flag_n_fe'] == 2) & # no [N/Fe]
%         ~((data['logg'] < 3.5) & (data['teff'] < 5500)) # not_giant
%     )
% )
%: $\mathrm{[C/N]} < -1$ for non-giants ($T_\text{eff} > 5500\,\mathrm{K}$ or $\log g > 3.5$) or no $\mathrm{[N/Fe]}$ measured for non-giants ($T_\text{eff} > 5500\,\mathrm{K}$ or $\log g > 3.5$) -> raising flag of $\mathrm{[C/Fe]}$ in that case as well as $\mathrm{[N/Fe]}$ extended non-giants ($T_\text{eff} > 5750\,\mathrm{K}$ or $\log g > 4.$ -> raising flag of $\mathrm{[N/Fe]}$ 
6 & 64 & measurement of Li, Ca, or Ba \\ %$ when CCD3 wavelength seems to be off (cdelt beyond the usual range of xx-xx) \\
\hline
\end{tabular}
\end{table}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Abundance detection or upper limit}
\label{sec:abundance_detection_or_upper_limit}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

To assess if the abundance estimates are a true detection or an upper limit for element X, we produce synthetic spectra with the same stellar labels, but decrease the abundance [X/Fe] to the lower limit of the neural network (or decrease the [Fe/H] value by -0.5 for Fe). The residuals in units of sigma between the best-fit spectrum and spectrum with lowest possible [X/Fe] or lowered [Fe/H] then allow us to identify a detection (with maximum differences beyond 3 sigma) or upper limits, for which we raise the flag \textsc{flag\_x\_fe} by 1. We note again that our initial test of overall detectability (Sec.~\ref{sec:which_labels_are_optimised}) allowed us identify elements for which not even an upper limit was expected, raising flag \textsc{flag\_x\_fe} by 2.

%Our pipeline will find the most suitable model and in particular set of abundances for the given observation. That does, however, not necessarily mean that the abundance of each element is actually well determined, because lines of the element may actually not be detected. For each element, we therefore run a post-processing routine to estimate if the measured abundance is indeed significant compared to the uncertainty of the spectrum. For each star, we therefore take the best-fit labels and neural network model and assess the change in the model spectrum when changing one abundance at a time to the lower boundary of the neural network model. If the difference between the spectrum of the best-fit and the lowest possible abundance is not above $3\sigma$ for a given elemental label, we do not consider it a reliable detection and thus raise the flag \textsc{flag\_x\_fe} for this label.

%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% \subsection{Goodness of fit}
%% \label{sec:goodness_of_fit}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%% Raise flag\_sp by 4
%
%% \subsection{Rotational broadening}
%
%% vsini only provided from 1.5 to 24.
%
%% Values below 0 and above 25 raise flag\_sp b 8
%
%% \subsection{Emission lines}
%
%% We use the composite trapezoidal rule to estimate equivalent width for emission based on the difference between observed and model spectrum around $2\,\mathrm{\AA}$ of each Balmer line. We flag the spectrum (raising flag\_sp by 16), if the observed spectrum is without a doubt in emission with a median observed flux above zero for the Balmer line cores ($\pm 0.5\,\mathrm{\AA}$ of the line center).
%
%% \subsection{Flagging of problematic measurements}
%
%% \SB{Flag if parameters outside of the range of \TheCannon (e.g. \vsini$ > 30 \kms$, see Sec.~\ref{subsubsec:polynomials})}
%
%% \SB{Flag if parameters are outside of convex hull of isochrone grid, when using photoastrometric information. Also note that we have cut away \Teff above $10,000\K$ and \logg above $6\dex$.}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{VALIDATION}
\label{sec:validation}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Automatic Post-Processing Performance}

In this section, we try to estimate how reliable the automatic flags of GALAH DR4 are.

Spectra have been classified by eye
% saved at GALAH_DR4/validation/spectrum_classification_by_eye.xlsx

\begin{itemize}
    \item Spectroscopic Binary Type 1 (SB1) classification, Fig.~\ref{fig:examples_flag_sp_2}
    \item Spectroscopic Binary Type 2 (SB2) classification, Fig.~\ref{fig:examples_flag_sp_3}
    \item Equivalent width estimates of three diffuse interstellar bands (5780.59, 5797.19, $6613.66\,\text{\AA}$) with central wavelengths identified by \citet{Vogrincic2023} as well as for interstellar K ($7698.9643\,\text{\AA}$), see Fig.~\ref{fig:example_dibs_06453479-0102137}
    \item Emission classification and measurement, Fig.~\ref{fig:examples_flag_sp_1}
    \item Upper Limit estimation
\end{itemize}

\subsection{False positive rates for spectroscopic binaries}

Thanks to the \Gaia satellite the radial velocity estimates provided for bright stars from the \Gaia radial velocity spectrometer \citep{Katz2022}, we have radial velocity estimates for 94\% (774\,914) of the stars observed for GALAH DR4.

Fig.~\ref{fig:vrad_comparison_comp1_comp2_gaiadr3}

\begin{figure*}[hbt]
 \centering
 \includegraphics[width=\textwidth]{figures/vrad_comparison_comp1_comp2_gaiadr3.png}
 \caption{\textbf{Validation of C2 and CN molecular line fitting as part of GALAH DR4 for the $\mathrm{\omega Cen}$ member 2MASS J13283993-4726329.}} % 140314005201392
 \label{fig:vrad_comparison_comp1_comp2_gaiadr3}
\end{figure*}

Binarity. How accurate is the flagging. Compare ratios of true/false, false-positive detections aided by \citet{Traven2020}. Get in contact with Alex Wallace and Andy Casey regarding their binarity identification from BP/RP spectra.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{DATA RELEASE PRODUCTS}
\label{sec:catalogues_release_products}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Data release catalogues}
\label{sec:data_release_catalogues}

\begin{enumerate}
   \item galah\_dr4\_allspec.fits: analysis for each spectrum (incl. RV) assuming single star
   \item galah\_dr4\_allstar.fits: analysis for each star based on co-added spectra for each star and using non-spectropic information to constrain \logg
   \item galah\_dr4\_binary.fits: analysis for those spectra that are suspected line-splitting spectroscopic binaries (SB2) assuming two sources for spectrum with same [Fe/H] but different RV
\end{enumerate}

\begin{table*}
\caption{Table schema of the GALAH DR4 main catalogues.} \label{tab:main_catalog_schema1}
\centering
\begin{tabular}{lccc}
\hline\hline
Keyword	&	Type	&	Description	&	Section	\\
\hline
sobject\_id	&	int64	&	GALAH identifier	&		\\
tmass\_id	&	str	&	2MASS identifier	&		\\
gaiadr3\_source\_id	&	int64	&	Gaia DR3 source\_id	&		\\
survey\_name	&	str	&	HERMES-2dF Survey/Program/Pointing (other if not available)	&		\\
field\_id	&	int32	&	GALAH Field ID (-1 if not available)	&		\\
setup	&	str	&	Analysis setup: single/binary/coadds	&		\\
mjd	&	float32	&	Modified Julian Date	&		\\
ra	&	float64	&	propagated from Gaia DR3	&		\\
dec	&	float64	&	propagated from Gaia DR3	&		\\
best\_spec4star	&	bool	&	Best spectrum for given star (identifiable via 2MASS ID)	&		\\
flag\_sp	&	int32	&	Major spectroscopic quality bitmask flag	&		\\
flag\_sp\_fit	&	int32	&	Major spectroscopic fitting quality bitmask flag	&		\\
opt\_loop	&	int32	&	Nr of optimisation loops used for fitting	&		\\
flag\_red	&	int32	&	Quality bitmask flag of reduction pipeline	&		\\
snr\_px\_ccdx	&	float32	&	Average signal-to-noise ratio (per pixel) of CCDX	&		\\
chi2\_sp	&	float32	&	Chi2 value of spectroscopic fitting	&		\\
px\_used\_perc	&	int64	&	Percentage of spectrum used for spectroscopic fit	&		\\
model\_name	&	str	&	Neural network model used for creating synthetic spectra	&		\\
closest\_model	&	str	&	Neural network model closest for Teff/logg/[Fe/H] combination	&		\\
comp\_time	&	float32	&	Computation time spent on spectrum	&		\\
flux\_contr	&	float32	&	Flux contribution of main source	&		\\
e\_flux\_contr	&	float32	&	Uncertainty flux\_contr	&		\\
rv\_comp\_nr	&	int64	&	Number of peaks in RV cross-correlation function (CCF)	&		\\
rv\_comp\_x	&	float32	&	Radial velocity of primary or secondary sourcex	&		\\
e\_rv\_comp\_x	&	float32	&	Uncertainty of rv\_comp\_x	&		\\
rv\_comp\_x\_h	&	float32	&	Height of rv\_comp\_x in CCF	&		\\
rv\_comp\_x\_p	&	float32	&	Prominence of rv\_comp\_x in CCF	&		\\
rv\_gaia\_dr3	&	float32	&	Radial velocity in Gaia DR3	&		\\
e\_rv\_gaia\_dr3	&	float32	&	Uncertainty of rv\_gaia\_dr3	&		\\
v\_bary\_eff	&	float64	&	Barycentric velocity applied to reduced spectra	&		\\
teff	&	float32	&	Spectroscopic effective temperature (used for fitting)	&		\\
e\_teff	&	float32	&	Uncertainty teff	&		\\
logg	&	float64	&	Surface gravity adjusted via parallax information	&		\\
e\_logg	&	float32	&	Uncertainty logg\_plx	&		\\
fe\_h	&	float32	&	Abundance of Fe and all other elements not fitted in GALAH (Fe: 1D-NLTE)	&		\\
e\_fe\_h	&	float32	&	Uncertainty fe\_h	&		\\
flag\_fe\_h	&	int32	&	Quality flag fe\_h	&		\\
vmic	&	float32	&	Microturbulence velocity (fitted)	&		\\
e\_vmic	&	float32	&	Uncertainty vmic	&		\\
vsini	&	float32	&	Broadening velocity (fitted sme.vsini with sme.vmac=0)	&		\\
e\_vsini	&	float32	&	Uncertainty of vsini	&		\\
x\_comp\_2	&	float32	&	Parameter value x of potential secondary source	&		\\
e\_x\_comp\_2	&	float32	&	Uncertainty of x\_comp\_2	&		\\
x\_fe	&	float32	&	Elemental abundance for [X/Fe]	&		\\
e\_x\_fe	&	float32	&	Uncertainty x\_fe	&		\\
flag\_x\_fe	&	int32	&	Quality bitmask flag of x\_fe	&		\\
\hline
\end{tabular}
\end{table*}

\begin{table*}
\caption{Table schema of the GALAH DR4 main catalogues. (Continuation of Tab.~\ref{tab:main_catalog_schema1}).} \label{tab:main_catalog_schema2}
\centering
\begin{tabular}{lccc}
\hline
Keyword	&	Type	&	Description	&	Section	\\
\hline
sb2\_rv\_16	&	float32	&	16th perc. radial velocity of fit to syn-obs residuals	&		\\
sb2\_rv\_50	&	float32	&	50th perc. radial velocity of fit to syn-obs residuals	&		\\
sb2\_rv\_84	&	float32	&	84th perc. radial velocity of fit to syn-obs residuals	&		\\
ew\_h\_beta	&	float32	&	Equivalent Width of fit for syn-obs residuals at Hbeta core	&		\\
ew\_h\_alpha	&	float32	&	Equivalent Width of fit for syn-obs residuals at Halpha core	&		\\
ew\_k\_is	&	float32	&	Equivalent Width of fit for K7699 Interstellar Line	&		\\
sigma\_k\_is	&	float32	&	Sigma auf Gaussian fit for K7699 Interstellar Line	&		\\
rv\_k\_is	&	float32	&	Radial velocity of fit to syn-obs residuals around K7699 line	&		\\
ew\_dibX	&	float32	&	Equivalent Width of fit for X Diffiuse Interstellar Band	&		\\
sigma\_dibX	&	float32	&	Sigma auf Gaussian fit for X DIB	&		\\
rv\_dibX	&	float32	&	Radial velocity of fit to syn-obs residuals around X DIB	&		\\
logg\_spec	&	float32	&	Spectroscopic surface gravity (used for fitting)	&		\\
e\_logg\_spec	&	float32	&	Uncertainty logg\_spec	&		\\
phot\_g\_mean\_mag	&	float32	&	Mean Gaia DR3 G-band apparent magnitude	&		\\
phot\_bp\_mean\_mag	&	float32	&	Mean Gaia DR3 BP-band apparent magnitude	&		\\
bp\_rp	&	float32	&	Color of BP-RP bands	&		\\
h\_m	&	float32	&	2MASS H-band magnitude	&		\\
h\_msigcom	&	float32	&	Uncertainty of h\_m	&		\\
ks\_m	&	float32	&	2MASS Ks-band magnitude	&		\\
ks\_msigcom	&	float32	&	Uncertainty of ks\_m	&		\\
W2mag	&	float32	&	AllWISE W2-band magnitude	&		\\
e\_W2mag	&	float32	&	uncertainty of W2mag	&		\\
ebv	&	float32	&	Extinction E(B-V)	&		\\
parallax	&	float32	&	Astrometric parallax used for GALAH DR4	&		\\
e\_parallax	&	float32	&	Uncertainty of astrometric parallax used for GALAH DR4	&		\\
parallax\_gaia\_edr3	&	float32	&	Parallax reported with corrections by Gaia EDR3	&		\\
e\_parallax\_gaia\_edr3	&	float32	&	Uncertainty of parallax reported with corrections by Gaia EDR3	&		\\
ruwe\_gaia\_dr3	&	float32	&	RUWE reported by Gaia DR3	&		\\
r\_med	&	float32	&	Median Distance used for calculating logg(plx)	&		\\
r\_lo	&	float32	&	Lower Limit Distance used for calculating logg(plx)	&		\\
r\_hi	&	float32	&	Higher Limit Distance used for calculating logg(plx)	&		\\
a\_ks	&	float32	&	Attenuation in Ks-band A(Ks) used for calculating logg(plx)	&		\\
mass	&	float32	&	Mass used for calculating logg(plx)	&		\\
age	&	float32	&	Age estimated when calculating mass	&		\\
bc\_ks	&	float32	&	Bolometric Correction of Ks, BC(Ks), used for calculating logg(plx)	&		\\
lbol	&	float32	&	Bolometric Luminosity used for calculating logg(plx)	&		\\
\hline
\end{tabular}
\end{table*}

\begin{landscape}
\begin{figure}
\includegraphics[width=0.975\columnwidth]{figures/galah_dr4_overview_allspec.png}
\caption{
\textbf{Overview of stellar parameters and elemental abundances for the \textit{allspec} estimates of GALAH DR4.}
\textbf{The top left panel} shows the density distribution of stars in the Kiel diagram of \Teff and \logg.
\textbf{All other panels} show the logarithmic elemental abundances (for elements indicated in the top left of the panel) as a function of the logarithmic iron abundances {[Fe/H]}. Elements are colored by different nucleosynthetis channcels (black for big bang nucleosynthetis, blue for core-collapse supernovae, red for supernovae type Ia, green for asymptotic giant branch star contributions and pink for the rapid neutron capture process with contributions from merging neutron stars) following the color schema from \citet{Kobayashi2020}.
}
\label{fig:galah_dr4_overview_allspec}
\end{figure}
\end{landscape}


\subsection{Data products for each spectrum}
\label{sec:data_products_for_each_spectrum}

\begin{enumerate}
   \item 210115002201239\_single\_fit\_comparison.pdf (see Fig.~\ref{fig:210115002201239_single_fit_comparison}) \SB{Maybe actually use OmegaCen star 140314005201392: cool, metal-poor, strong CNO features and a good spectrum to explain why continuum points may not always work for a pipeline.}
   \item 210115002201239\_single\_fit\_covariances.npz
   \item 210115002201239\_single\_fit\_results.fits
   \item 210115002201239\_single\_fit\_rv.png (see Fig.~\ref{fig:181221003101356_single_fit_rv})
   \item 210115002201239\_single\_fit\_spectrum.fits
\end{enumerate}

%\begin{figure*}[hbt]
% \centering  
% \includegraphics[width=0.9\textwidth]{figures/210115002201239_single_fit_comparison.pdf}
%\caption{\textbf{Comparison of the observed (black) and best-fit spectrum (red) for the 2dF-HERMES spectrum of the asteroid 4~Vesta.} Important element lines are annotated in each of the wavelength regions colored by their element group. Vertical areas indicate masked regions that were neglected for the label optimisation, most notably $\mathrm{H}_\beta$ at $4861\,\text{\AA}$ and $\mathrm{H}_\alpha$ at $6563\,\text{\AA}$. \SB{Maybe actually use OmegaCen star 140314005201392: cool, metal-poor, strong CNO features and a good spectrum to explain why continuum points may not always work for a pipeline. See Sec.~\ref{sec:data_products_for_each_spectrum}}} \label{fig:210115002201239_single_fit_comparison}
%\end{figure*}

\section{CAVEATS AND FUTURE IMPROVEMENTS} \label{sec:caveats}

\subsection{Limitations of our implemented multiple neural networks}

\subsubsection{Consistency between models and noding in the 3Ddomain}

\subsubsection{Flexibility of our neural network implementation for extreme abundances}

While this approach has proved to be powerful for all elements across their abundance ranges, we have noticed sinusoidal shapes for weak Li lines \citep[see also][]{Wang2020}. This is likely caused by the large dynamical range that has to be covered by the neural network of $0 < \mathrm{A(Li)} < 4$. \SB{Elaborate on this! Ella's EW estimation code will limit the impact of this caveat!}

\subsection{Which analysis setup should be used?}

\subsubsection{To use or not to use non-spectroscopic information?}

An implementation of non-spectroscopic information, as done in our \textit{allstar} module, has the advantage of overcome spectroscopic degeneracies (as proven for the limited information on \logg in the HERMES wavelength range) as well as improving accuracy and precision also for the lowest quality spectra (because \logg is no longer solely dependent on the spectrum information).

However, this approach is only useful if the non-spectroscopic information not biased (as it would be for astrometric and photometric information in the case of unresolved binarity). In this case, the \textit{binary} module should be favoured and we have tried to implement a sophisticated decision algorithm to decide if a spectrum is including contributions from a second source or just a fast rotating star.

\subsection{Binary or fast rotator?}

\SB{Example of a warm main sequence turn-off star that could be a binary, but shows no clear line-splitting.}

\subsection{Unreliable wavelength solutions}

For each CCD, the reduction has found the most suitable wavelength solution, linking pixels with actual wavelengths, based on the ThXe arc lines. In GALAH DR3 \citep{Buder2021}, we have found several issues for spectra, where not enough ThXe lines could be used to constrain the wavelength solution. Improvements have been made for the new reduction version to improve the number of useful ThXe lines. Two additional pieces of information are, however, unused by the reduction pipeline, namely (i) the telluric lines that are present throughout GALAH spectra and (ii) the absorption lines of the stellar spectra. Both hold valuable information, as their position (in rest wavelength) is known very well. \SB{This has affacted mainly CCD3 with Li and Eu. One could estimate wavelength solutions from arc lines + telluric lines + absorption features.}

\SB{Note that I have also monitored the CRVAL1 and CDELT1 estimates with quite a few surprising outliers\footnote{validation/figures/galah\_dr4\_crval\_cdelt\_histograms.png}: 7.9\% for CCD3 have CDELT1 significantly outside (mainly above) the expected values. CCD4 shows 2.2 and 2.1\%, respectively, with outliers in CRVAL1 and CDELT1.}

% The reduction is providing spectra and other parameters in an array of $n$ pixels, that is linked to wavelengths $\lambda_n$ through a linear function
% \begin{align} \label{eq:wavelength_solution}
%     \lambda (n) = \lambda_0 + n \cdot \Delta_\lambda.
% \end{align}
% In particular, for each CCD, the pipeline reports $\lambda_0$ as \texttt{cdelt} and $\Delta_\lambda$ as \texttt{CRVAl}.\footnote{\SB{Can we take into account uncertainties on these values through the pipeline? e.g. rms?}}
% Because we can directly compare to model spectra with a perfect wavelength solution, we therefore allow these eight values (two for each of the four CCDs) to be fitted by our analysis pipeline.

% \SB{Could this be degenarate with \vrad. Could be solved by (i) keeping one CCD fixed or (ii) adding a fit to the telluric lines as well, because we know their dependence on wavelength!}

\subsection{Chemical composition differences of model atmospheres and spectra}

\SB{For several of our synthetic spectra, the chosen chemical composition differs significantly from the scaled-Solar pattern of the \textsc{MARCS} model atmospheres. We note that APOGEE DR17 \citep{SDSSDR17} have managed to compute \textsc{MARCS} that match their chemical compositions.}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{CONCLUSIONS}
\label{sec:conclusion}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section*{Acknowledgements}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

We acknowledge the traditional owners of the land on which the AAT and ANU stand, the Gamilaraay, the Ngunnawal and Ngambri people. We pay our respects to elders past, present, and emerging and are proud to continue their tradition of surveying the night sky in the Southern hemisphere.
This work was supported by the Australian Research Council Centre of Excellence for All Sky Astrophysics in 3 Dimensions (ASTRO 3D), through project number CE170100013.

\section*{Facilities}

\textbf{AAT with 2df-HERMES at Siding Spring Observatory:}
AAT observations for this data relerase were performed under programs {2013B/13}, {2014A/25}, {2015A/3}, {2015A/19}, {2015B/1}, {2015B/19}, {2016A/22}, {2016B/10}, {2016B/12}, {2017A/14}, {2017A/18}, {2017B/16}, {2018A/18}, {2018B/15}, {2019A/1}, {2019A/15}, and {2020/B23}. This paper includes data that has been provided by AAO Data Central (datacentral.aao.gov.au).
\textbf{\Gaia: } This work has made use of data from the European Space Agency (ESA) mission \Gaia (\url{http://www.cosmos.esa.int/gaia}), processed by the \Gaia Data Processing and Analysis Consortium (DPAC, \url{http://www.cosmos.esa.int/web/gaia/dpac/consortium}). Funding for the DPAC has been provided by national institutions, in particular the institutions participating in the \Gaia Multilateral Agreement. 
\textbf{Other facilities:} This publication makes use of data products from the Two Micron All Sky Survey \citep{Skrutskie2006} and the CDS VizieR catalogue access tool \citep{Vizier2000}.

\section*{Software}

The research for this publication was coded in \textsc{python} (version 3.7.4) and included its packages
\textsc{astropy} \citep[v. 3.2.2;][]{Robitaille2013,PriceWhelan2018},
\textsc{astroquery} \citep[v. 0.4;][]{Ginsburg2019},
\textsc{corner} \citep[v. 2.0.1;][]{corner},
\textsc{galpy} \citep[version 1.6.0;][]{Bovy2015},
\textsc{IPython} \citep[v. 7.8.0;][]{ipython},
\textsc{matplotlib} \citep[v. 3.1.3;][]{matplotlib},
\textsc{NumPy} \citep[v. 1.17.2;][]{numpy},
\textsc{scipy} \citep[version 1.3.1;][]{scipy},
\textsc{sklearn} \citep[v. 0.21.3;][]{scikit-learn},
We further made use of \textsc{topcat} \citep[version 4.7;][]{Taylor2005};


\bibliography{bib}

\appendix

\section{Initial parameters}

\begin{figure*}[ht]
 \centering
 \includegraphics[width=\textwidth]{figures/initial_teff_logg.png}
 \includegraphics[width=\textwidth]{figures/initial_teff_fe_h.png}
 \includegraphics[width=\textwidth]{figures/initial_teff_vmic.png}
 \includegraphics[width=\textwidth]{figures/initial_teff_vsini.png} \caption{\textbf{Comparison of initial parameters used for GALAH DR4 (first column) with the GALAH DR4 reduction pipeline (second column), \Gaia DR3 (third column with \vmic based on the adjusted formula from \citet{DutraFerreira2016}), and GALAH DR3 (fourth column).}} \label{fig:initial_parameters}
\end{figure*}

\section{Example Fit Comparison}

\begin{figure*}[ht]
 \centering
 \includegraphics[width=0.9\textwidth]{figures/210115002201239_single_fit_comparison.pdf} \caption{\textbf{Example output of the \textit{allspec} fitting routine for VESTA / 210115002201239.}} \label{fig:210115002201239_single_fit_comparison}
\end{figure*}

\end{document}
